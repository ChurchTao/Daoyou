# 管道架构设计

<cite>
**本文引用的文件**
- [engine/battle/pipeline/DamagePipeline.ts](file://engine/battle/pipeline/DamagePipeline.ts)
- [engine/battle/pipeline/HealPipeline.ts](file://engine/battle/pipeline/HealPipeline.ts)
- [engine/battle/pipeline/EffectPipeline.ts](file://engine/battle/pipeline/EffectPipeline.ts)
- [engine/battle/pipeline/types.ts](file://engine/battle/pipeline/types.ts)
- [engine/battle/pipeline/stages/damage/BaseDamageStage.ts](file://engine/battle/pipeline/stages/damage/BaseDamageStage.ts)
- [engine/battle/pipeline/stages/damage/BeforeDamageStage.ts](file://engine/battle/pipeline/stages/damage/BeforeDamageStage.ts)
- [engine/battle/pipeline/stages/damage/ApplyDamageStage.ts](file://engine/battle/pipeline/stages/damage/ApplyDamageStage.ts)
- [engine/battle/pipeline/stages/damage/AfterDamageStage.ts](file://engine/battle/pipeline/stages/damage/AfterDamageStage.ts)
- [engine/battle/pipeline/stages/effect/ExecuteEffectStage.ts](file://engine/battle/pipeline/stages/effect/ExecuteEffectStage.ts)
- [engine/battle/pipeline/stages/heal/BaseHealStage.ts](file://engine/battle/pipeline/stages/heal/BaseHealStage.ts)
- [engine/battle/pipeline/stages/heal/BeforeHealStage.ts](file://engine/battle/pipeline/stages/heal/BeforeHealStage.ts)
- [engine/battle/pipeline/stages/heal/ApplyHealStage.ts](file://engine/battle/pipeline/stages/heal/ApplyHealStage.ts)
- [engine/battle/SkillExecutor.ts](file://engine/battle/SkillExecutor.ts)
- [engine/battle/BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts)
- [engine/battle/types.ts](file://engine/battle/types.ts)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考量](#性能考量)
8. [故障排查指南](#故障排查指南)
9. [结论](#结论)
10. [附录](#附录)

## 引言
本文件系统性阐述“战斗管道架构”的设计与实现，聚焦于伤害、治疗与通用效果三类管道如何协同工作，以及技能执行器如何将技能效果分派至相应管道，从而实现高内聚、可扩展、可维护的战斗计算体系。该架构通过“纯编排器 + 管道阶段”的模式，将复杂战斗逻辑拆分为可测试、可组合的步骤，便于未来新增阶段或调整顺序。

## 项目结构
围绕战斗系统的管道架构主要位于 engine/battle/pipeline 目录，包含三类管道与统一的类型定义；技能执行器负责根据技能效果类型进行分派；战斗引擎负责回合调度与全局状态管理。

```mermaid
graph TB
subgraph "战斗管道"
DP["DamagePipeline<br/>伤害管道"]
HP["HealPipeline<br/>治疗管道"]
EP["EffectPipeline<br/>通用效果管道"]
end
subgraph "管道阶段"
DStages["伤害阶段集合<br/>Base/Before/Apply/After"]
HStages["治疗阶段集合<br/>Base/Before/Apply"]
EStage["效果执行阶段<br/>ExecuteEffectStage"]
end
SE["SkillExecutor<br/>技能执行器"]
BE["BattleEngineV2<br/>战斗引擎"]
DP --> DStages
HP --> HStages
EP --> EStage
SE --> DP
SE --> HP
SE --> EP
BE --> SE
```

图表来源
- [engine/battle/pipeline/DamagePipeline.ts](file://engine/battle/pipeline/DamagePipeline.ts#L1-L81)
- [engine/battle/pipeline/HealPipeline.ts](file://engine/battle/pipeline/HealPipeline.ts#L1-L69)
- [engine/battle/pipeline/EffectPipeline.ts](file://engine/battle/pipeline/EffectPipeline.ts#L1-L70)
- [engine/battle/SkillExecutor.ts](file://engine/battle/SkillExecutor.ts#L1-L320)
- [engine/battle/BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts#L1-L580)

章节来源
- [engine/battle/pipeline/DamagePipeline.ts](file://engine/battle/pipeline/DamagePipeline.ts#L1-L81)
- [engine/battle/pipeline/HealPipeline.ts](file://engine/battle/pipeline/HealPipeline.ts#L1-L69)
- [engine/battle/pipeline/EffectPipeline.ts](file://engine/battle/pipeline/EffectPipeline.ts#L1-L70)
- [engine/battle/SkillExecutor.ts](file://engine/battle/SkillExecutor.ts#L1-L320)
- [engine/battle/BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts#L1-L580)

## 核心组件
- 管道与阶段
  - 伤害管道 DamagePipeline：按顺序执行基础伤害、伤害前处理、应用伤害、伤害后处理四个阶段。
  - 治疗管道 HealPipeline：按顺序执行基础治疗、治疗前处理、应用治疗三个阶段。
  - 通用效果管道 EffectPipeline：执行非伤害/治疗类效果（如增益、法力吸取、驱散等）。
  - 统一类型与上下文：DamagePipelineContext、HealPipelineContext、EffectPipelineContext，以及 PipelineStage 接口与 PipelineResult 结构。
- 技能执行器 SkillExecutor：根据技能效果类型将效果分派到对应管道，聚合结果并处理闪避、资源消耗与日志。
- 战斗引擎 BattleEngineV2：驱动回合制战斗，决定行动顺序、处理控制与 Buff、触发回合开始/结束效果、记录时间线与结果。

章节来源
- [engine/battle/pipeline/types.ts](file://engine/battle/pipeline/types.ts#L1-L225)
- [engine/battle/pipeline/DamagePipeline.ts](file://engine/battle/pipeline/DamagePipeline.ts#L1-L81)
- [engine/battle/pipeline/HealPipeline.ts](file://engine/battle/pipeline/HealPipeline.ts#L1-L69)
- [engine/battle/pipeline/EffectPipeline.ts](file://engine/battle/pipeline/EffectPipeline.ts#L1-L70)
- [engine/battle/SkillExecutor.ts](file://engine/battle/SkillExecutor.ts#L1-L320)
- [engine/battle/BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts#L1-L580)

## 架构总览
下图展示从战斗引擎到技能执行器再到各类管道的整体调用链路与职责边界。

```mermaid
sequenceDiagram
participant BE as "BattleEngineV2"
participant SE as "SkillExecutor"
participant DP as "DamagePipeline"
participant HP as "HealPipeline"
participant EP as "EffectPipeline"
BE->>SE : "execute(actor, target, skill, turn)"
alt "伤害类技能"
SE->>DP : "executeForSkill(caster, effectTarget, skill, turn)"
DP-->>SE : "PipelineResult"
else "治疗类技能"
SE->>HP : "executeForSkill(caster, effectTarget, skill, turn)"
HP-->>SE : "PipelineResult"
else "其他效果"
SE->>EP : "executeForEffect(caster, effectTarget, skill, effectConfig, turn)"
EP-->>SE : "PipelineResult"
end
SE-->>BE : "SkillExecutionResult"
BE->>BE : "consumeResources(), setCooldown()"
```

图表来源
- [engine/battle/BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts#L1-L580)
- [engine/battle/SkillExecutor.ts](file://engine/battle/SkillExecutor.ts#L1-L320)
- [engine/battle/pipeline/DamagePipeline.ts](file://engine/battle/pipeline/DamagePipeline.ts#L1-L81)
- [engine/battle/pipeline/HealPipeline.ts](file://engine/battle/pipeline/HealPipeline.ts#L1-L69)
- [engine/battle/pipeline/EffectPipeline.ts](file://engine/battle/pipeline/EffectPipeline.ts#L1-L70)

## 详细组件分析

### 管道与阶段类图
```mermaid
classDiagram
class PipelineStage {
+name : string
+priority : number
+process(ctx) : void
}
class DamagePipeline {
-stages : PipelineStage[]
+addStage(stage) : this
+execute(ctx) : PipelineResult
+createDefault() : DamagePipeline
+executeForSkill(caster, target, skill, currentTurn) : PipelineResult
}
class HealPipeline {
-stages : PipelineStage[]
+addStage(stage) : this
+execute(ctx) : PipelineResult
+createDefault() : HealPipeline
+executeForSkill(caster, target, skill, currentTurn) : PipelineResult
}
class EffectPipeline {
-stages : PipelineStage[]
+addStage(stage) : this
+execute(ctx) : PipelineResult
+createDefault() : EffectPipeline
+executeForEffect(caster, target, skill, effectConfig, currentTurn) : PipelineResult
}
class BaseDamageStage
class BeforeDamageStage
class ApplyDamageStage
class AfterDamageStage
class ExecuteEffectStage
class BaseHealStage
class BeforeHealStage
class ApplyHealStage
DamagePipeline --> BaseDamageStage : "包含"
DamagePipeline --> BeforeDamageStage : "包含"
DamagePipeline --> ApplyDamageStage : "包含"
DamagePipeline --> AfterDamageStage : "包含"
HealPipeline --> BaseHealStage : "包含"
HealPipeline --> BeforeHealStage : "包含"
HealPipeline --> ApplyHealStage : "包含"
EffectPipeline --> ExecuteEffectStage : "包含"
```

图表来源
- [engine/battle/pipeline/DamagePipeline.ts](file://engine/battle/pipeline/DamagePipeline.ts#L1-L81)
- [engine/battle/pipeline/HealPipeline.ts](file://engine/battle/pipeline/HealPipeline.ts#L1-L69)
- [engine/battle/pipeline/EffectPipeline.ts](file://engine/battle/pipeline/EffectPipeline.ts#L1-L70)
- [engine/battle/pipeline/stages/damage/BaseDamageStage.ts](file://engine/battle/pipeline/stages/damage/BaseDamageStage.ts#L1-L75)
- [engine/battle/pipeline/stages/damage/BeforeDamageStage.ts](file://engine/battle/pipeline/stages/damage/BeforeDamageStage.ts#L1-L72)
- [engine/battle/pipeline/stages/damage/ApplyDamageStage.ts](file://engine/battle/pipeline/stages/damage/ApplyDamageStage.ts#L1-L90)
- [engine/battle/pipeline/stages/damage/AfterDamageStage.ts](file://engine/battle/pipeline/stages/damage/AfterDamageStage.ts#L1-L72)
- [engine/battle/pipeline/stages/effect/ExecuteEffectStage.ts](file://engine/battle/pipeline/stages/effect/ExecuteEffectStage.ts#L1-L43)
- [engine/battle/pipeline/stages/heal/BaseHealStage.ts](file://engine/battle/pipeline/stages/heal/BaseHealStage.ts)
- [engine/battle/pipeline/stages/heal/BeforeHealStage.ts](file://engine/battle/pipeline/stages/heal/BeforeHealStage.ts)
- [engine/battle/pipeline/stages/heal/ApplyHealStage.ts](file://engine/battle/pipeline/stages/heal/ApplyHealStage.ts)

章节来源
- [engine/battle/pipeline/types.ts](file://engine/battle/pipeline/types.ts#L1-L225)
- [engine/battle/pipeline/DamagePipeline.ts](file://engine/battle/pipeline/DamagePipeline.ts#L1-L81)
- [engine/battle/pipeline/HealPipeline.ts](file://engine/battle/pipeline/HealPipeline.ts#L1-L69)
- [engine/battle/pipeline/EffectPipeline.ts](file://engine/battle/pipeline/EffectPipeline.ts#L1-L70)

### 伤害管道执行序列
```mermaid
sequenceDiagram
participant SE as "SkillExecutor"
participant DP as "DamagePipeline"
participant B as "BaseDamageStage"
participant BD as "BeforeDamageStage"
participant AD as "ApplyDamageStage"
participant AF as "AfterDamageStage"
SE->>DP : "executeForSkill(caster, target, skill, turn)"
DP->>B : "process(ctx)"
B-->>DP : "ctx : baseDamage, element, flags"
DP->>BD : "process(ctx)"
BD-->>DP : "ctx : damage, isCritical, shieldAbsorbed"
DP->>AD : "process(ctx)"
AD-->>DP : "ctx : actualDamage, logs"
DP->>AF : "process(ctx)"
AF-->>DP : "ctx : logs"
DP-->>SE : "PipelineResult"
```

图表来源
- [engine/battle/SkillExecutor.ts](file://engine/battle/SkillExecutor.ts#L1-L320)
- [engine/battle/pipeline/DamagePipeline.ts](file://engine/battle/pipeline/DamagePipeline.ts#L1-L81)
- [engine/battle/pipeline/stages/damage/BaseDamageStage.ts](file://engine/battle/pipeline/stages/damage/BaseDamageStage.ts#L1-L75)
- [engine/battle/pipeline/stages/damage/BeforeDamageStage.ts](file://engine/battle/pipeline/stages/damage/BeforeDamageStage.ts#L1-L72)
- [engine/battle/pipeline/stages/damage/ApplyDamageStage.ts](file://engine/battle/pipeline/stages/damage/ApplyDamageStage.ts#L1-L90)
- [engine/battle/pipeline/stages/damage/AfterDamageStage.ts](file://engine/battle/pipeline/stages/damage/AfterDamageStage.ts#L1-L72)

### 治疗管道执行序列
```mermaid
sequenceDiagram
participant SE as "SkillExecutor"
participant HP as "HealPipeline"
participant BH as "BaseHealStage"
participant BH2 as "BeforeHealStage"
participant AH as "ApplyHealStage"
SE->>HP : "executeForSkill(caster, target, skill, turn)"
HP->>BH : "process(ctx)"
BH-->>HP : "ctx : baseHeal"
HP->>BH2 : "process(ctx)"
BH2-->>HP : "ctx : heal"
HP->>AH : "process(ctx)"
AH-->>HP : "ctx : actualHeal, logs"
HP-->>SE : "PipelineResult"
```

图表来源
- [engine/battle/SkillExecutor.ts](file://engine/battle/SkillExecutor.ts#L1-L320)
- [engine/battle/pipeline/HealPipeline.ts](file://engine/battle/pipeline/HealPipeline.ts#L1-L69)
- [engine/battle/pipeline/stages/heal/BaseHealStage.ts](file://engine/battle/pipeline/stages/heal/BaseHealStage.ts)
- [engine/battle/pipeline/stages/heal/BeforeHealStage.ts](file://engine/battle/pipeline/stages/heal/BeforeHealStage.ts)
- [engine/battle/pipeline/stages/heal/ApplyHealStage.ts](file://engine/battle/pipeline/stages/heal/ApplyHealStage.ts)

### 通用效果管道执行序列
```mermaid
sequenceDiagram
participant SE as "SkillExecutor"
participant EP as "EffectPipeline"
participant EX as "ExecuteEffectStage"
SE->>EP : "executeForEffect(caster, target, skill, effectConfig, turn)"
EP->>EX : "process(ctx)"
EX-->>EP : "ctx : value, logs"
EP-->>SE : "PipelineResult"
```

图表来源
- [engine/battle/SkillExecutor.ts](file://engine/battle/SkillExecutor.ts#L1-L320)
- [engine/battle/pipeline/EffectPipeline.ts](file://engine/battle/pipeline/EffectPipeline.ts#L1-L70)
- [engine/battle/pipeline/stages/effect/ExecuteEffectStage.ts](file://engine/battle/pipeline/stages/effect/ExecuteEffectStage.ts#L1-L43)

### 伤害阶段算法流程（BeforeDamageStage）
```mermaid
flowchart TD
Start(["进入 BeforeDamageStage"]) --> CheckDamage["damage > 0 ?"]
CheckDamage --> |否| Stop["shouldContinue = false<br/>提前结束"]
CheckDamage --> |是| CollectEffects["收集技能中 ON_BEFORE_DAMAGE 效果"]
CollectEffects --> CallEngine["EffectEngine.processWithContext(ON_BEFORE_DAMAGE)"]
CallEngine --> UpdateCtx["更新 damage/isCritical/shieldAbsorbed"]
UpdateCtx --> MaybeDeferred["是否有延迟日志?"]
MaybeDeferred --> |是| AppendLogs["追加到 ctx.deferredLogs"]
MaybeDeferred --> |否| End(["完成"])
Stop --> End
```

图表来源
- [engine/battle/pipeline/stages/damage/BeforeDamageStage.ts](file://engine/battle/pipeline/stages/damage/BeforeDamageStage.ts#L1-L72)

### 技能执行器分派与闪避流程
```mermaid
flowchart TD
S0["开始 execute(caster, target, skill, turn)"] --> Classify["分类技能类型"]
Classify --> IsDamage{"是否伤害类?"}
IsDamage --> |是| EvadeCheck["检查闪避(命中率/控制状态)"]
EvadeCheck --> Evaded{"是否闪避?"}
Evaded --> |是| HandleEvasion["记录闪避日志并触发 ON_DODGE"]
HandleEvasion --> ConsumeRes["消耗 MP/设置冷却"]
Evaded --> |否| Dispatch["按效果类型分派到管道"]
IsDamage --> |否| Dispatch
Dispatch --> Merge["合并管道结果(damage/healing/logs)"]
Merge --> EnsureLog["确保技能使用日志"]
EnsureLog --> ConsumeRes
ConsumeRes --> Done["返回 SkillExecutionResult"]
```

图表来源
- [engine/battle/SkillExecutor.ts](file://engine/battle/SkillExecutor.ts#L1-L320)

## 依赖分析
- 组件耦合
  - SkillExecutor 依赖三类管道与 EffectEngine（用于闪避命中率、前后置效果触发），但不直接包含具体效果逻辑，符合“纯编排器”原则。
  - 各管道内部通过 StagePriority 控制阶段顺序，Stage 间通过上下文共享数据，降低耦合度。
- 外部依赖
  - EffectEngine 与 EffectFactory 在阶段中被调用，用于创建与执行具体效果。
  - BattleUnit 提供战斗单位能力（如 applyDamage、setCooldown 等），被管道与执行器共同使用。
- 循环依赖
  - 管道与阶段之间为单向依赖，未见循环导入迹象。
- 接口契约
  - PipelineStage/process(ctx) 为统一接口，PipelineResult 为标准化输出，便于扩展与测试。

```mermaid
graph LR
SE["SkillExecutor"] --> DP["DamagePipeline"]
SE --> HP["HealPipeline"]
SE --> EP["EffectPipeline"]
DP --> DStages["伤害阶段"]
HP --> HStages["治疗阶段"]
EP --> EStage["效果阶段"]
DStages --> EE["EffectEngine/EffectFactory"]
HStages --> EE
EStage --> EE
SE --> BU["BattleUnit"]
```

图表来源
- [engine/battle/SkillExecutor.ts](file://engine/battle/SkillExecutor.ts#L1-L320)
- [engine/battle/pipeline/DamagePipeline.ts](file://engine/battle/pipeline/DamagePipeline.ts#L1-L81)
- [engine/battle/pipeline/HealPipeline.ts](file://engine/battle/pipeline/HealPipeline.ts#L1-L69)
- [engine/battle/pipeline/EffectPipeline.ts](file://engine/battle/pipeline/EffectPipeline.ts#L1-L70)

章节来源
- [engine/battle/SkillExecutor.ts](file://engine/battle/SkillExecutor.ts#L1-L320)
- [engine/battle/pipeline/types.ts](file://engine/battle/pipeline/types.ts#L1-L225)

## 性能考量
- 阶段排序与短路
  - 管道在 addStage 时按优先级排序，确保关键阶段（如 Before/After）在正确时机执行；当 damage<=0 或 shouldContinue=false 时提前终止，减少无效计算。
- 日志与延迟日志
  - 延迟日志（deferredLogs）在 ApplyDamageStage 后统一追加，避免阶段内频繁 I/O，提升吞吐。
- 随机性与命中率
  - 闪避判定与技能选择包含随机因素，建议在需要稳定性的场景（如回放/测试）注入种子或屏蔽随机性。
- 可扩展性
  - 新增阶段只需实现 PipelineStage 接口并设定合理优先级，不影响既有阶段；通过 EffectEngine 扩展效果类型，无需修改管道结构。

## 故障排查指南
- 管道执行异常
  - DamagePipeline/HealPipeline/EffectPipeline 在执行阶段时捕获异常并记录日志，同时将阶段名称写入日志以便定位问题。
- 伤害为 0 或被闪避
  - 若 damage<=0，BeforeDamageStage 会短路；若目标处于眩晕/根系状态，闪避判定不会生效，需检查控制 Buff 与命中率计算。
- 日志缺失
  - 确认 EffectFactory 创建的效果是否正确设置 EffectLogCollector 并在阶段中读取日志；对于非伤害/治疗效果，确保 EffectPipeline 正常执行。
- 结果不一致
  - 检查 SkillExecutor 的效果分派逻辑与 trigger 条件（仅处理 ON_SKILL_HIT）；确认 Buff/装备效果是否正确参与 ON_BEFORE_DAMAGE/ON_AFTER_DAMAGE/ON_BEING_HIT 触发。

章节来源
- [engine/battle/pipeline/DamagePipeline.ts](file://engine/battle/pipeline/DamagePipeline.ts#L1-L81)
- [engine/battle/pipeline/HealPipeline.ts](file://engine/battle/pipeline/HealPipeline.ts#L1-L69)
- [engine/battle/pipeline/EffectPipeline.ts](file://engine/battle/pipeline/EffectPipeline.ts#L1-L70)
- [engine/battle/SkillExecutor.ts](file://engine/battle/SkillExecutor.ts#L1-L320)

## 结论
该管道架构通过“纯编排器 + 管道阶段”的方式，将复杂的战斗计算拆解为清晰、可测试、可扩展的步骤。Damage/Heal/Effect 三类管道分别覆盖核心战斗要素，SkillExecutor 负责分派与聚合，BattleEngineV2 负责回合与全局状态管理。整体设计具备良好的内聚性与较低耦合，便于持续演进与维护。

## 附录
- 关键类型与常量
  - StagePriority：定义各阶段优先级，数字越小越先执行。
  - PipelineStage/PipelineResult：统一阶段接口与结果结构。
  - DamagePipelineContext/HealPipelineContext/EffectPipelineContext：三类管道的上下文，承载计算中间态与日志。
  - 元素相克、暴击倍率、最大闪避率、最大减伤率等常量定义于战斗类型文件。

章节来源
- [engine/battle/pipeline/types.ts](file://engine/battle/pipeline/types.ts#L1-L225)
- [engine/battle/types.ts](file://engine/battle/types.ts#L1-L147)