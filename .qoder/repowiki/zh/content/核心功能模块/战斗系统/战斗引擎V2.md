# 战斗引擎V2

<cite>
**本文档引用的文件**
- [BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts)
- [BattleUnit.ts](file://engine/battle/BattleUnit.ts)
- [SkillExecutor.ts](file://engine/battle/SkillExecutor.ts)
- [types.ts](file://engine/battle/types.ts)
- [DamagePipeline.ts](file://engine/battle/pipeline/DamagePipeline.ts)
- [HealPipeline.ts](file://engine/battle/pipeline/HealPipeline.ts)
- [EffectPipeline.ts](file://engine/battle/pipeline/EffectPipeline.ts)
- [types.ts](file://engine/battle/pipeline/types.ts)
- [BaseDamageStage.ts](file://engine/battle/pipeline/stages/damage/BaseDamageStage.ts)
- [BeforeDamageStage.ts](file://engine/battle/pipeline/stages/damage/BeforeDamageStage.ts)
- [ApplyDamageStage.ts](file://engine/battle/pipeline/stages/damage/ApplyDamageStage.ts)
- [AfterDamageStage.ts](file://engine/battle/pipeline/stages/damage/AfterDamageStage.ts)
- [BaseHealStage.ts](file://engine/battle/pipeline/stages/heal/BaseHealStage.ts)
- [BeforeHealStage.ts](file://engine/battle/pipeline/stages/heal/BeforeHealStage.ts)
- [ApplyHealStage.ts](file://engine/battle/pipeline/stages/heal/ApplyHealStage.ts)
- [ExecuteEffectStage.ts](file://engine/battle/pipeline/stages/effect/ExecuteEffectStage.ts)
- [route.ts](file://app/api/battle/route.ts)
- [cultivator.ts](file://types/cultivator.ts)
</cite>

## 目录
1. [简介](#简介)
2. [核心架构](#核心架构)
3. [战斗流程](#战斗流程)
4. [关键组件分析](#关键组件分析)
5. [状态系统](#状态系统)
6. [计算模块](#计算模块)
7. [API接口](#api接口)
8. [数据模型](#数据模型)
9. [结论](#结论)

## 简介

战斗引擎V2是本修仙游戏的核心战斗系统，采用模块化设计，集成了状态管理、属性计算、技能执行等复杂功能。该引擎负责处理玩家与对手之间的战斗模拟，包括回合制战斗、技能释放、状态效果、伤害计算等核心机制。引擎设计注重可扩展性和性能优化，通过状态容器和计算器模块实现了高度解耦的架构。

## 核心架构

战斗引擎V2采用面向对象的设计模式，以`BattleEngineV2`类为核心，协调多个子系统协同工作。整个系统围绕战斗单元（`BattleUnit`）展开，每个战斗单元都拥有独立的状态容器（`StatusContainer`），用于管理其所有临时和持久状态。

```mermaid
graph TD
A[BattleEngineV2] --> B[BattleUnit]
A --> C[SkillExecutor]
A --> D[DamagePipeline]
A --> E[HealPipeline]
A --> F[EffectPipeline]
B --> G[EffectEngine]
C --> H[EffectEngine]
D --> G
E --> G
F --> G
```

**图源**
- [BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts#L30-L149)
- [BattleUnit.ts](file://engine/battle/BattleUnit.ts#L119-L151)
- [SkillExecutor.ts](file://engine/battle/SkillExecutor.ts#L54-L90)
- [DamagePipeline.ts](file://engine/battle/pipeline/DamagePipeline.ts#L29-L81)
- [HealPipeline.ts](file://engine/battle/pipeline/HealPipeline.ts#L11-L69)
- [EffectPipeline.ts](file://engine/battle/pipeline/EffectPipeline.ts#L11-L70)

## 战斗流程

战斗引擎V2的战斗流程遵循严格的回合制逻辑，每个回合包含多个阶段，确保战斗的公平性和可预测性。

```mermaid
flowchart TD
Start([开始战斗]) --> Init["初始化战斗状态"]
Init --> Snapshot["记录初始快照"]
Snapshot --> Loop["主循环"]
Loop --> Tick["刷新状态"]
Tick --> CheckDeath["检查是否有单位死亡"]
CheckDeath --> |是| End["结束战斗"]
CheckDeath --> |否| Order["决定行动顺序"]
Order --> Action["执行行动"]
Action --> Cooldown["递减冷却"]
Cooldown --> Record["记录回合快照"]
Record --> Loop
End --> Result["生成战斗结果"]
Result --> Finish([战斗结束])
```

**图源**
- [BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts#L45-L51)
- [BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts#L87-L149)

## 关键组件分析

### BattleEngineV2

`BattleEngineV2`是战斗引擎的主控制器，负责协调整个战斗流程。它通过`simulateBattle`方法启动战斗，该方法接受玩家和对手的修仙者数据作为输入，并返回完整的战斗结果。

**战斗状态接口**
```typescript
interface BattleState {
  player: BattleUnit;
  opponent: BattleUnit;
  turn: number;
  log: string[];
  timeline: TurnSnapshot[];
  maxTurns: number;
}
```

**战斗结果接口**
```typescript
interface BattleEngineResult {
  winner: Cultivator;
  loser: Cultivator;
  log: string[];
  turns: number;
  playerHp: number;
  opponentHp: number;
  timeline: TurnSnapshot[];
  playerPersistentStatuses?: Array<{
    statusKey: string;
    potency: number;
    createdAt: number;
    metadata: Record<string, unknown>;
  }>;
  opponentPersistentStatuses?: Array<{
    statusKey: string;
    potency: number;
    createdAt: number;
    metadata: Record<string, unknown>;
  }>;
}
```

**节源**
- [BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts#L17-L24)
- [types.ts](file://engine/battle/types.ts#L57-L81)

### BattleUnit

`BattleUnit`类封装了战斗中的单位状态，是战斗系统的核心数据结构。每个战斗单元都包含基础属性、动态属性、状态容器和技能冷却等信息。

- 新增 BattleEntity 接口实现，统一属性查询与效果收集
- 新增临时技能效果管理（如 CounterAttackEffect），支持在战斗中动态挂载/移除
- 新增属性缓存与脏标记，减少重复计算

**节源**
- [BattleUnit.ts](file://engine/battle/BattleUnit.ts#L17-L324)
- [BattleUnit.ts](file://engine/battle/BattleUnit.ts#L119-L151)
- [BattleUnit.ts](file://engine/battle/BattleUnit.ts#L589-L618)

### SkillExecutor

`SkillExecutor`负责执行技能逻辑，包括伤害、治疗、状态施加等。它通过`execute`方法处理不同类型的技能，并根据技能类型调用相应的执行方法。

```mermaid
sequenceDiagram
participant Caster as "施法者"
participant Target as "目标"
participant Executor as "SkillExecutor"
Caster->>Executor : execute(skill)
Executor->>Executor : checkEvasion()
alt 闪避成功
Executor->>Target : 闪避日志
Executor->>Caster : 设置冷却
Executor-->>Caster : 返回结果
else 未闪避
Executor->>Executor : dispatchToPipelines()
Executor->>Executor : consumeResources()
Executor-->>Caster : 返回结果
end
```

**图源**
- [SkillExecutor.ts](file://engine/battle/SkillExecutor.ts#L58-L90)
- [SkillExecutor.ts](file://engine/battle/SkillExecutor.ts#L118-L177)

## 管道系统与日志格式改进

战斗引擎V2引入了全新的管道系统，将技能效果的执行拆分为可插拔的阶段，显著提升了可扩展性与可维护性。同时，日志格式进行了优化，按效果类型分组展示，便于阅读与回放。

### 管道系统概览

- 伤害管道 DamagePipeline：按阶段顺序执行基础伤害、伤害前处理、应用伤害、伤害后处理
- 治疗管道 HealPipeline：按阶段顺序执行基础治疗、治疗前处理、应用治疗
- 通用效果管道 EffectPipeline：处理 AddBuff、ManaDrain、Dispel 等非伤害/治疗效果

```mermaid
classDiagram
class DamagePipeline {
+addStage(stage)
+execute(ctx)
+static createDefault()
+static executeForSkill(...)
}
class HealPipeline {
+addStage(stage)
+execute(ctx)
+static createDefault()
+static executeForSkill(...)
}
class EffectPipeline {
+addStage(stage)
+execute(ctx)
+static createDefault()
+static executeForEffect(...)
}
class BaseDamageStage
class BeforeDamageStage
class ApplyDamageStage
class AfterDamageStage
class BaseHealStage
class BeforeHealStage
class ApplyHealStage
class ExecuteEffectStage
DamagePipeline --> BaseDamageStage
DamagePipeline --> BeforeDamageStage
DamagePipeline --> ApplyDamageStage
DamagePipeline --> AfterDamageStage
HealPipeline --> BaseHealStage
HealPipeline --> BeforeHealStage
HealPipeline --> ApplyHealStage
EffectPipeline --> ExecuteEffectStage
```

**图源**
- [DamagePipeline.ts](file://engine/battle/pipeline/DamagePipeline.ts#L29-L81)
- [HealPipeline.ts](file://engine/battle/pipeline/HealPipeline.ts#L11-L69)
- [EffectPipeline.ts](file://engine/battle/pipeline/EffectPipeline.ts#L11-L70)
- [BaseDamageStage.ts](file://engine/battle/pipeline/stages/damage/BaseDamageStage.ts#L1-L75)
- [BeforeDamageStage.ts](file://engine/battle/pipeline/stages/damage/BeforeDamageStage.ts#L1-L72)
- [ApplyDamageStage.ts](file://engine/battle/pipeline/stages/damage/ApplyDamageStage.ts#L1-L90)
- [AfterDamageStage.ts](file://engine/battle/pipeline/stages/damage/AfterDamageStage.ts#L1-L72)
- [BaseHealStage.ts](file://engine/battle/pipeline/stages/heal/BaseHealStage.ts#L1-L60)
- [BeforeHealStage.ts](file://engine/battle/pipeline/stages/heal/BeforeHealStage.ts#L1-L44)
- [ApplyHealStage.ts](file://engine/battle/pipeline/stages/heal/ApplyHealStage.ts#L1-L37)
- [ExecuteEffectStage.ts](file://engine/battle/pipeline/stages/effect/ExecuteEffectStage.ts)

### 日志格式改进

- 回合结束触发（ON_TURN_END）时，法力回复效果会单独标注“（装备效果）”，并将其与其他日志合并展示，提升可读性
- 伤害阶段在应用伤害后追加延迟日志（如护盾耗尽），保证日志顺序与实际效果发生时间一致

**节源**
- [BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts#L222-L265)
- [ApplyDamageStage.ts](file://engine/battle/pipeline/stages/damage/ApplyDamageStage.ts#L54-L58)

### 法力再生效果处理优化

- 回合结束时通过 EffectEngine 触发 ON_TURN_END，集中处理 HOT 治疗与回复类效果
- 对法力回复进行专门标注，明确来源（如装备效果），避免与技能/状态产生的回复混淆

**节源**
- [BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts#L222-L265)

## 状态系统

战斗引擎V2的状态系统是其最复杂的部分之一，采用`StatusContainer`和`StatusRegistry`两个核心组件来管理所有状态。

### StatusContainer

`StatusContainer`负责管理单个角色的所有临时状态，包括状态的添加、移除、刷新和计算。它维护两个映射：`statusesById`和`statusesByKey`，分别按ID和Key索引状态。

**节源**
- [StatusContainer.ts](file://engine/status/StatusContainer.ts#L26-L446)

### StatusRegistry

`StatusRegistry`是状态注册表，维护所有状态的元信息，作为状态引擎的配置中心。它通过`registerStatus`方法注册状态定义，并通过`getDefinition`方法获取状态定义。

```mermaid
classDiagram
class StatusRegistry {
+definitions : Map<StatusEffect, StatusDefinition>
+calculators : Map<StatusEffect, EffectCalculator>
+registerStatus(definition : StatusDefinition) : void
+getDefinition(statusKey : StatusEffect) : StatusDefinition | undefined
+registerCalculator(statusKey : StatusEffect, calculator : EffectCalculator) : void
+getCalculator(statusKey : StatusEffect) : EffectCalculator | undefined
}
class StatusContainer {
-statusesById : Map<string, StatusInstance>
-statusesByKey : Map<StatusEffect, StatusInstance[]>
+addStatus(request : StatusApplicationRequest, target : UnitSnapshot) : ApplyResult
+removeStatus(statusId : string) : boolean
+hasStatus(statusKey : StatusEffect) : boolean
+tickStatuses(context : TickContext) : TickResult
+calculateAttributeModifications(context : CalculationContext) : AttributeModification
}
StatusRegistry --> StatusContainer : "提供状态定义"
StatusContainer --> StatusRegistry : "查询状态定义"
```

**图源**
- [StatusRegistry.ts](file://engine/status/StatusRegistry.ts#L13-L80)
- [StatusContainer.ts](file://engine/status/StatusContainer.ts#L26-L446)

## 计算模块

战斗引擎V2包含多个专门的计算器模块，用于处理不同的计算任务。

### DamageCalculator

`DamageCalculator`负责统一处理所有伤害计算，包括技能伤害、法宝伤害、元素加成、暴击判定和防御减伤。

**节源**
- [DamageCalculator.ts](file://engine/battle/calculators/DamageCalculator.ts#L15-L72)

### CriticalCalculator

`CriticalCalculator`负责计算暴击概率和暴击伤害。暴击率的计算公式为：(悟性 - 40) / 200，状态修正包括锋锐状态(+0.15)和暴击压制(-0.15)。

**节源**
- [CriticalCalculator.ts](file://engine/battle/calculators/CriticalCalculator.ts#L13-L99)

### EvasionCalculator

`EvasionCalculator`负责计算闪避概率。基础闪避率为min(0.3, (速度 + 速度增益) / 350)，特殊情况下如眩晕或定身状态则无法闪避。

**节源**
- [EvasionCalculator.ts](file://engine/battle/calculators/EvasionCalculator.ts#L9-L110)

### AttributeCalculator

`AttributeCalculator`负责计算战斗单元的最终属性，包括基础属性、装备加成和状态修正。

**节源**
- [AttributeCalculator.ts](file://engine/battle/calculators/AttributeCalculator.ts#L9-L71)

## API接口

战斗引擎通过API接口与前端交互，主要接口位于`app/api/battle/route.ts`。

### POST /api/battle

该接口用于执行战斗并生成战斗播报，采用SSE流式输出。接口接收角色ID和敌人ID，返回战斗结果和播报。

**请求参数**
- cultivatorId: 玩家角色ID
- opponentId: 对手角色ID

**响应格式**
- type: 消息类型(start, battle_result, chunk, done, error)
- data: 战斗结果数据
- content: 战斗播报内容块

**节源**
- [route.ts](file://app/api/battle/route.ts#L15-L172)

## 数据模型

战斗引擎依赖于`Cultivator`数据模型，该模型定义了修仙者的完整数据结构。

### Cultivator接口

`Cultivator`接口包含修仙者的所有属性，包括基础信息、修为境界、属性、灵根、命格、功法、技能、装备等。

**核心属性**
- id: 角色ID
- name: 名称
- realm: 修为境界
- attributes: 基础属性(体魄、灵力、悟性、速度、神识)
- spiritual_roots: 灵根
- skills: 技能列表
- inventory: 背包
- equipped: 已装备物品

**节源**
- [cultivator.ts](file://types/cultivator.ts#L242-L282)

## 结论

战斗引擎V2是一个功能完整、架构清晰的回合制战斗系统。通过引入管道系统，技能效果的执行被标准化、模块化，日志格式按效果类型分组展示，法力再生等回复效果得到更清晰的呈现。BattleUnit 的增强（临时技能效果管理、BattleEntity 接口）进一步提升了系统的灵活性与可扩展性。整体设计充分考虑了性能优化和错误处理，为游戏的稳定运行提供了坚实的基础。