# 状态效果系统

<cite>
**本文档引用的文件**  
- [BuffManager.ts](file://engine/buff/BuffManager.ts)
- [BuffRegistry.ts](file://engine/buff/BuffRegistry.ts)
- [EffectEngine.ts](file://engine/effect/EffectEngine.ts)
- [BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts)
- [buffs.ts](file://config/buffs.ts)
- [types.ts](file://engine/buff/types.ts)
- [types.ts](file://engine/effect/types.ts)
</cite>

## 更新摘要
**已做更改**  
- 将状态效果系统从旧的 `StatusContainer` 架构升级为基于 `BuffManager` 和 `EffectEngine` 的新系统
- 更新了核心组件、状态效果类型定义、状态叠加规则、持续伤害计算逻辑、回合状态处理流程等章节
- 新增了关于 `EffectEngine` 和 `BuffRegistry` 的详细说明
- 移除了已废弃的文件引用，添加了新文件引用

## 目录
1. [简介](#简介)
2. [核心组件](#核心组件)
3. [状态效果类型定义](#状态效果类型定义)
4. [状态叠加与互斥规则](#状态叠加与互斥规则)
5. [状态命中判定机制](#状态命中判定机制)
6. [持续伤害（DoT）计算逻辑](#持续伤害（dot）计算逻辑)
7. [回合状态处理流程](#回合状态处理流程)
8. [战斗时间线记录](#战斗时间线记录)
9. [架构概览](#架构概览)

## 简介
状态效果系统是本游戏战斗机制的核心组成部分，负责管理角色在战斗中受到的各种临时增益（buff）与减益（debuff）效果。该系统通过 `BuffManager` 类实现状态的添加、刷新与移除，并结合 `BuffRegistry` 进行统一配置管理。系统支持多种状态类型，包括灼烧、流血、中毒等持续伤害效果，以及护体、疾行、眩晕、沉默等控制与属性修正效果。

状态效果在每回合开始时统一处理，执行持续伤害结算、回合数递减与状态过期判断。系统还实现了精细的命中判定、元素加成、状态叠加与互斥逻辑，确保战斗体验的策略性与平衡性。

## 核心组件

状态效果系统由多个核心组件构成，主要包括：

- **BuffManager**：状态管理器，管理单个实体身上的所有 Buff，提供添加、刷新、移除等操作接口。
- **BuffRegistry**：状态注册表，集中管理所有 Buff 配置的元数据定义。
- **BuffConfig**：状态配置，描述每种状态的基础属性，如名称、类型、默认持续时间、是否可叠加等。
- **BuffInstance**：状态实例，表示一个具体生效中的状态，包含当前剩余回合、层数、来源等运行时信息。
- **EffectEngine**：效果引擎，统一处理所有效果的执行，通过管道模式计算属性修正、伤害、治疗等。
- **EffectContext**：效果上下文，包含来源、目标、触发时机、当前数值等信息。

系统通过 `tick` 方法在每回合执行状态效果处理，结合 `EffectEngine` 实现更灵活的效果系统。

**本节来源**  
- [BuffManager.ts](file://engine/buff/BuffManager.ts#L11-L334)
- [BuffRegistry.ts](file://engine/buff/BuffRegistry.ts#L8-L54)
- [EffectEngine.ts](file://engine/effect/EffectEngine.ts#L12-L113)
- [types.ts](file://engine/buff/types.ts#L7-L131)
- [types.ts](file://engine/effect/types.ts#L1-L290)

## 状态效果类型定义

系统定义了多种状态效果类型，按功能可分为以下几类：

### 战斗增益状态（Buff）
| 状态键 | 显示名称 | 描述 | 持续时间（回合） |
|--------|--------|------|----------------|
| armor_up | 护体 | 减伤提升15% | 2 |
| speed_up | 疾行 | 速度提升20点 | 2 |
| crit_rate_up | 锋锐 | 暴击率提升15% | 2 |

### 战斗减益状态（Debuff）
| 状态键 | 显示名称 | 描述 | 持续时间（回合） |
|--------|--------|------|----------------|
| armor_down | 破防 | 减伤降低15% | 2 |
| crit_rate_down | 暴击压制 | 暴击率降低15% | 2 |

### 控制状态（Control）
| 状态键 | 显示名称 | 描述 | 持续时间（回合） |
|--------|--------|------|----------------|
| stun | 眩晕 | 无法行动 | 1 |
| silence | 沉默 | 无法使用技能 | 2 |
| root | 定身 | 无法闪避 | 2 |

### 持续伤害状态（DoT）
| 状态键 | 显示名称 | 元素 | 最大叠加层数 | 持续时间（回合） |
|--------|--------|------|--------------|----------------|
| burn | 灼烧 | 火 | 3 | 3 |
| bleed | 流血 | 金 | 3 | 3 |
| poison | 中毒 | 木 | 5 | 3 |

所有状态效果均在 `BuffRegistry` 中注册，确保类型安全与配置统一。

**本节来源**  
- [buffs.ts](file://config/buffs.ts#L17-L208)
- [types.ts](file://engine/buff/types.ts#L45-L64)
- [types.ts](file://engine/effect/types.ts#L131-L145)

## 状态叠加与互斥规则

### 叠加规则
- **正面状态（Buff）**：不可叠加，施加时会刷新持续时间。
- **负面状态（Debuff）**：部分可叠加，如 `burn`、`bleed`、`poison` 支持叠加，但有最大层数限制。
  - `burn` 与 `bleed` 最多叠加3层
  - `poison` 最多叠加5层
- 超过最大叠加层数时，状态施加失败。

### 互斥规则
某些状态之间存在互斥关系，施加新状态时会自动移除旧状态：
- `armor_up` 与 `armor_down` 互斥
- `crit_rate_up` 与 `crit_rate_down` 互斥

此机制通过 `conflictsWith` 字段在状态定义中声明，并在 `addBuff` 时自动处理。

```mermaid
flowchart TD
A[尝试施加状态] --> B{是否已存在同类型状态?}
B --> |否| C[创建新实例]
B --> |是| D{是否可叠加?}
D --> |否| E[刷新持续时间]
D --> |是| F{是否达到最大层数?}
F --> |否| G[增加一层]
F --> |是| H[施加失败]
```

**本节来源**  
- [BuffManager.ts](file://engine/buff/BuffManager.ts#L52-L80)
- [buffs.ts](file://config/buffs.ts#L39-L41)
- [types.ts](file://engine/buff/types.ts#L33-L40)

## 状态命中判定机制

状态效果的命中基于技能威力与目标意志力计算命中概率，公式如下：

```
基础命中率 = min(0.8, max(0.2, 技能威力 / 2.5 / 100))
抵抗率 = min(0.7, 目标意志力 / 3000)
最终命中率 = max(0.2, 基础命中率 × (1 - 抵抗率))
```

对于 `debuff` 和 `control` 类型状态，目标可通过意志力进行抵抗。系统在 `addBuff` 时调用 `resistanceCalculator.calculateResistance` 计算抵抗概率，并以随机数判定是否成功命中。

```mermaid
sequenceDiagram
participant 施法者
participant 状态容器
participant 目标
施法者->>状态容器 : addBuff(request)
状态容器->>状态容器 : 验证状态合法性
状态容器->>状态容器 : 计算抵抗概率
状态容器->>目标 : roll随机数 < 抵抗率?
目标-->>状态容器 : 是 → 抵抗成功
目标-->>状态容器 : 否 → 施加成功
状态容器-->>施法者 : 返回结果
```

**本节来源**  
- [BuffManager.ts](file://engine/buff/BuffManager.ts#L43-L49)
- [BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts#L264-L266)
- [types.ts](file://engine/buff/types.ts#L123-L130)

## 持续伤害（DoT）计算逻辑

持续伤害（Damage over Time, DoT）的计算综合考虑基础比例、威力系数、施法者灵力与元素加成：

### 基础伤害公式
```
基础伤害 = (目标基础气血 × 基础比例) + (威力 × 系数) + (施法者灵力 × 0.15)
```

### 各状态参数
| 状态 | 基础比例 | 威力系数 | 元素 |
|------|--------|--------|------|
| burn | 7% | 0.2 | 火 |
| bleed | 6% | 0.2 | 金 |
| poison | 5% | 0.25 | 木 |

### 伤害修正
- **元素加成**：若施法者拥有对应元素灵根，伤害乘以元素倍率（如火灵根1.5倍）
- **防御减免**：最终伤害乘以目标减伤系数

系统通过 `DotDamageEffect` 执行计算，并在 `processTurnStartEffects` 中应用伤害。

```mermaid
flowchart TD
A[进入processTurnStartEffects] --> B{状态类型为DoT?}
B --> |是| C[构建计算上下文]
C --> D[调用DotDamageEffect.apply]
D --> E[计算基础伤害]
E --> F[应用元素加成]
F --> G[应用防御减免]
G --> H[扣除目标气血]
H --> I[记录日志]
```

**本节来源**  
- [BuffManager.ts](file://engine/buff/BuffManager.ts#L148-L195)
- [BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts#L208-L219)
- [types.ts](file://engine/effect/types.ts#L226-L234)

## 回合状态处理流程

每回合开始时，系统调用 `processTurnStart` 函数处理所有单位的状态：

1. **执行持续伤害**：对 `dot` 类型状态，计算并施加持续伤害
2. **递减持续时间**：对 `turn` 类型状态，`remaining` 减1
3. **检查状态过期**：若 `remaining <= 0`，标记为过期
4. **移除过期状态**：从容器中移除所有过期状态
5. **记录日志**：生成状态效果与消退的日志信息

该流程在 `BattleEngine.v2.ts` 的主循环中执行，确保所有单位的状态同步刷新。

```mermaid
flowchart TD
A[回合开始] --> B[processTurnStart(玩家)]
B --> C[processTurnStart(对手)]
C --> D{状态剩余回合 <= 0?}
D --> |是| E[标记为过期]
D --> |否| F[继续]
E --> G[执行持续伤害]
G --> H[移除状态]
H --> I[记录日志]
```

**本节来源**  
- [BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts#L87-L95)
- [BuffManager.ts](file://engine/buff/BuffManager.ts#L148-L195)
- [BattleUnit.ts](file://engine/battle/BattleUnit.ts#L395-L444)

## 战斗时间线记录

系统通过 `timeline` 数组记录每回合的状态快照，用于战斗回放与分析：

- **快照内容**：包含回合号、双方单位的气血、灵力与当前状态列表
- **记录时机**：
  - 第0回合：战斗开始前的初始状态
  - 每个完整回合结束后
  - 战斗结束时（可能在回合中途）
- **数据结构**：`TurnSnapshot` 包含 `player` 与 `opponent` 的 `TurnUnitSnapshot`

快照通过 `snapshotTurn` 函数生成，确保战斗过程可追溯。

**本节来源**  
- [BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts#L458-L472)
- [BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts#L146-L148)
- [types.ts](file://engine/battle/types.ts#L1-L20)

## 架构概览

```mermaid
graph TB
subgraph "状态定义"
Registry[BuffRegistry]
Config[BuffConfig]
end
subgraph "状态管理"
Manager[BuffManager]
Instance[BuffInstance]
Event[BuffEvent]
end
subgraph "效果系统"
Engine[EffectEngine]
Context[EffectContext]
Effect[BaseEffect]
Factory[EffectFactory]
end
subgraph "战斗引擎"
BattleEngine[BattleEngineV2]
Tick[tick]
Apply[addBuff]
end
Registry --> Manager
Config --> Registry
Instance --> Manager
Event --> Manager
Manager --> Effect
Effect --> Engine
Engine --> Factory
BattleEngine --> Tick
BattleEngine --> Apply
Tick --> Manager
Apply --> Manager
```

**本节来源**  
- [BuffManager.ts](file://engine/buff/BuffManager.ts)
- [BuffRegistry.ts](file://engine/buff/BuffRegistry.ts)
- [EffectEngine.ts](file://engine/effect/EffectEngine.ts)
- [BattleEngine.v2.ts](file://engine/battle/BattleEngine.v2.ts)