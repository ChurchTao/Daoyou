# 部署与运维

<cite>
**本文档中引用的文件**  
- [vercel.json](file://vercel.json)
- [next.config.ts](file://next.config.ts)
- [drizzle.config.ts](file://drizzle.config.ts)
- [ENV_SETUP.md](file://ENV_SETUP.md)
- [lib/drizzle/db.ts](file://lib/drizzle/db.ts)
- [lib/drizzle/schema.ts](file://lib/drizzle/schema.ts)
- [app/api/cron/rank-rewards/route.ts](file://app/api/cron/rank-rewards/route.ts)
- [app/api/market/route.ts](file://app/api/market/route.ts)
- [lib/redis/index.ts](file://lib/redis/index.ts)
- [lib/supabase/client.ts](file://lib/supabase/client.ts)
- [lib/supabase/server.ts](file://lib/supabase/server.ts)
- [types/constants.ts](file://types/constants.ts)
</cite>

## 目录
1. [简介](#简介)
2. [Vercel 一键部署指南](#vercel-一键部署指南)
3. [vercel.json 配置详解](#verceljson-配置详解)
4. [next.config.ts 构建优化设置](#nextconfigts-构建优化设置)
5. [数据库迁移：Drizzle CLI 使用说明](#数据库迁移drizzle-cli-使用说明)
6. [环境变量配置](#环境变量配置)
7. [监控、日志与故障排查](#监控日志与故障排查)

## 简介
本文档为《万界道友》项目提供完整的部署与运维操作指南，涵盖从 Vercel 一键部署、环境变量配置、构建优化、数据库迁移到日常监控与故障排查的全流程。目标是确保项目能够稳定上线并高效维护。

## Vercel 一键部署指南
本项目已针对 Vercel 平台进行优化，支持一键部署。

### 部署步骤
1. 访问 [Vercel 官网](https://vercel.com/) 并登录。
2. 点击 "New Project" 或 "Import Project"。
3. 连接你的代码仓库（如 GitHub、GitLab）。
4. 选择本项目仓库 `wanjiedaoyou`。
5. Vercel 会自动检测到 `next.config.ts` 并识别为 Next.js 项目。
6. 在部署配置页面，根据 `ENV_SETUP.md` 的要求，设置所有必需的环境变量。
7. 点击 "Deploy" 按钮。
8. 部署完成后，Vercel 将提供一个唯一的 URL（如 `wanjiedaoyou.vercel.app`），项目即可通过该地址访问。

**Section sources**
- [next.config.ts](file://next.config.ts#L1-L8)
- [package.json](file://package.json#L5-L11)

## vercel.json 配置详解
`vercel.json` 文件用于配置 Vercel 平台的高级功能，如定时任务（Cron Jobs）。

### 文件结构与功能
```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "crons": [
    {
      "path": "/api/market",
      "schedule": "0 1 * * *"
    },
    {
      "path": "/api/cron/rank-rewards",
      "schedule": "0 0 * * *"
    }
  ]
}
```

### 配置项说明
- **`$schema`**: 指向 Vercel JSON Schema 的链接，用于 IDE 提供智能提示。
- **`crons`**: 定义定时任务的数组。
  - **`path`**: 指定要触发的 API 路由。
  - **`schedule`**: 使用标准的 crontab 语法定义执行计划。

### 定时任务详情
1. **市场刷新任务**
   - **路径**: `/api/market`
   - **计划**: `0 1 * * *` (每天凌晨 1 点 UTC 执行)
   - **功能**: 调用 `app/api/market/route.ts` 中的 `GET` 接口，刷新游戏内坊市的商品列表。该接口利用 Redis 缓存和锁机制，确保在高并发下也能安全地生成新的商品。

2. **排行榜奖励结算任务**
   - **路径**: `/api/cron/rank-rewards`
   - **计划**: `0 0 * * *` (每天午夜 0 点 UTC 执行)
   - **功能**: 调用 `app/api/cron/rank-rewards/route.ts` 中的 `GET` 接口，为排行榜前 100 名的修仙者发放灵石奖励。奖励金额根据排名不同而有所差异，具体数值定义在 `types/constants.ts` 的 `RANKING_REWARDS` 常量中。

**Section sources**
- [vercel.json](file://vercel.json#L1-L14)
- [app/api/market/route.ts](file://app/api/market/route.ts#L1-L100)
- [app/api/cron/rank-rewards/route.ts](file://app/api/cron/rank-rewards/route.ts#L1-L68)
- [types/constants.ts](file://types/constants.ts#L182-L189)

## next.config.ts 构建优化设置
`next.config.ts` 是 Next.js 项目的核心配置文件，用于定义构建和运行时行为。

### 当前配置分析
```ts
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;
```
目前该文件是一个基础模板，未包含具体的优化配置。但项目已通过其他方式实现了优化。

### 实际优化策略
尽管 `next.config.ts` 为空，但项目通过以下方式实现优化：
- **依赖项管理**: `package.json` 中明确列出了所有生产依赖和开发依赖，确保构建环境的纯净。
- **静态资源处理**: 利用 Next.js 内置的 `app` 目录和 `page.tsx` 组件，自动进行代码分割和静态生成（SSG）。
- **API 路由**: 所有 API 接口位于 `app/api` 目录下，被自动配置为 Serverless Functions，适合 Vercel 的边缘网络部署。

**Section sources**
- [next.config.ts](file://next.config.ts#L1-L8)
- [package.json](file://package.json#L13-L32)

## 数据库迁移：Drizzle CLI 使用说明
本项目使用 Drizzle ORM 进行数据库管理，通过 `drizzle-kit` CLI 工具实现数据库模式的同步。

### 配置文件分析
`drizzle.config.ts` 文件定义了 Drizzle CLI 的行为：
```ts
import { defineConfig } from 'drizzle-kit';

export default defineConfig({
  dialect: 'postgresql', // 使用 PostgreSQL 数据库
  schema: './lib/drizzle/schema.ts', // 指向数据库模式定义文件
  tablesFilter: ['wanjiedaoyou_*'], // 只管理以 'wanjiedaoyou_' 开头的表
  dbCredentials: {
    url: `${process.env.DATABASE_URL}`, // 从环境变量读取数据库连接字符串
  },
});
```

### 数据库模式定义
`lib/drizzle/schema.ts` 文件是数据库的“单一事实来源”（Single Source of Truth），它使用 TypeScript 定义了所有数据库表的结构，例如 `cultivators`（修仙者表）、`materials`（材料表）等。任何对数据库结构的修改都应首先在此文件中进行。

### Drizzle CLI 常用命令
1. **推送模式到数据库 (Push)**
   ```bash
   npx drizzle-kit push
   ```
   此命令会将 `schema.ts` 中定义的最新模式直接应用到当前连接的数据库中。**警告**：此操作会直接修改生产数据库，仅在开发和测试环境谨慎使用。

2. **启动 Drizzle Studio**
   ```bash
   npx drizzle-kit studio
   ```
   此命令会启动一个 Web 界面，允许开发者以可视化的方式浏览数据库模式、执行 SQL 查询和管理数据，是调试和探索数据库的有力工具。

**Section sources**
- [drizzle.config.ts](file://drizzle.config.ts#L1-L10)
- [lib/drizzle/schema.ts](file://lib/drizzle/schema.ts#L1-L292)
- [lib/drizzle/db.ts](file://lib/drizzle/db.ts#L1-L12)

## 环境变量配置
正确的环境变量配置是项目正常运行的前提。

### 必需环境变量
根据 `ENV_SETUP.md` 文件，项目需要以下环境变量：

| 环境变量 | 说明 | 获取方式 |
| :--- | :--- | :--- |
| `DATABASE_URL` | PostgreSQL 数据库的连接字符串 | 在 Supabase 或其他 PostgreSQL 服务提供商的控制台中获取 |
| `NEXT_PUBLIC_SUPABASE_URL` | Supabase 项目的公开 URL | 在 Supabase 项目仪表板的 "Settings" -> "API" 中获取 |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Supabase 项目的匿名公钥 | 在 Supabase 项目仪表板的 "Settings" -> "API" 中获取 |
| `OPENAI_API_KEY` | OpenAI API 密钥 | 访问 [OpenAI 平台](https://platform.openai.com/api-keys) 生成 |
| `UPSTASH_REDIS_REST_URL` | Upstash Redis 的 REST URL | 在 [Upstash](https://upstash.com/) 控制台创建 Redis 实例后获取 |
| `UPSTASH_REDIS_REST_TOKEN` | Upstash Redis 的 REST 认证令牌 | 在 [Upstash](https://upstash.com/) 控制台创建 Redis 实例后获取 |

### 可选环境变量
| 环境变量 | 说明 | 默认值 |
| :--- | :--- | :--- |
| `OPENAI_BASE_URL` | 自定义 OpenAI 兼容 API 的基础地址 | `https://api.openai.com/v1` |
| `OPENAI_MODEL` | AI 模型名称 | `gpt-4o-mini` |

### 配置方法
- **开发环境**: 在项目根目录创建 `.env.local` 文件，并填入上述变量。
- **生产环境**: 在 Vercel 项目的 "Settings" -> "Environment Variables" 页面中添加所有环境变量。

**Section sources**
- [ENV_SETUP.md](file://ENV_SETUP.md#L1-L39)
- [lib/supabase/client.ts](file://lib/supabase/client.ts#L1-L9)
- [lib/supabase/server.ts](file://lib/supabase/server.ts#L1-L28)
- [lib/redis/index.ts](file://lib/redis/index.ts#L1-L6)
- [drizzle.config.ts](file://drizzle.config.ts#L8-L9)

## 监控、日志与故障排查
### 监控
- **Vercel Analytics**: 通过 `@vercel/analytics` 包收集用户行为数据，可在 Vercel 仪表板查看。
- **API 健康检查**: 定期访问 `/api/market` 和 `/api/cron/rank-rewards` 等关键接口，确保其返回 200 状态码。

### 日志查看
- **Vercel 日志**: 登录 Vercel 仪表板，进入项目页面，点击 "Logs" 标签页，可以查看所有 Serverless Functions 的执行日志，包括 `console.log` 输出和错误堆栈。
- **错误日志**: 关键错误（如数据库操作失败）已在代码中通过 `console.error` 记录，例如 `app/api/cron/rank-rewards/route.ts` 中的 `Rank rewards error`。

### 故障排查
1. **500 内部服务器错误**
   - 检查 Vercel 日志，定位错误发生的具体文件和行号。
   - 确认所有环境变量（尤其是数据库和 API 密钥）已正确配置。
   - 检查数据库连接是否正常。

2. **401 未授权错误**
   - 确认 `NEXT_PUBLIC_SUPABASE_ANON_KEY` 和 `NEXT_PUBLIC_SUPABASE_URL` 配置正确。
   - 检查用户会话是否过期。

3. **定时任务未执行**
   - 确认 `vercel.json` 文件已正确提交到仓库。
   - 在 Vercel 项目设置中检查 Cron Jobs 是否已启用。
   - 检查 `CRON_SECRET` 环境变量（如果代码中启用了验证）。

4. **Redis 连接失败**
   - 确认 `UPSTASH_REDIS_REST_URL` 和 `UPSTASH_REDIS_REST_TOKEN` 配置正确。
   - 检查 Upstash Redis 实例的状态。

**Section sources**
- [app/api/cron/rank-rewards/route.ts](file://app/api/cron/rank-rewards/route.ts#L61-L65)
- [app/api/market/route.ts](file://app/api/market/route.ts#L87-L91)
- [lib/redis/index.ts](file://lib/redis/index.ts#L3)
- [vercel.json](file://vercel.json#L3-L12)