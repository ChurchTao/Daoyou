# 数据库迁移脚本

<cite>
**本文档引用的文件**
- [0000_equal_the_fury.sql](file://drizzle/0000_equal_the_fury.sql)
- [0001_cynical_moonstone.sql](file://drizzle/0001_cynical_moonstone.sql)
- [0002_strong_proemial_gods.sql](file://drizzle/0002_strong_proemial_gods.sql)
- [0003_careless_tigra.sql](file://drizzle/0003_careless_tigra.sql)
- [0004_redundant_exiles.sql](file://drizzle/0004_redundant_exiles.sql)
- [0005_crazy_joseph.sql](file://drizzle/0005_crazy_joseph.sql)
- [0006_nice_wong.sql](file://drizzle/0006_nice_wong.sql)
- [0007_common_black_widow.sql](file://drizzle/0007_common_black_widow.sql)
- [0008_acoustic_nova.sql](file://drizzle/0008_acoustic_nova.sql)
- [0009_zippy_sharon_ventura.sql](file://drizzle/0009_zippy_sharon_ventura.sql)
- [0010_previous_silver_fox.sql](file://drizzle/0010_previous_silver_fox.sql)
- [0011_strong_the_spike.sql](file://drizzle/0011_strong_the_spike.sql)
- [0012_awesome_micromacro.sql](file://drizzle/0012_awesome_micromacro.sql)
- [0013_brown_nico_minoru.sql](file://drizzle/0013_brown_nico_minoru.sql)
- [0014_striped_sister_grimm.sql](file://drizzle/0014_striped_sister_grimm.sql)
- [0015_freezing_marvex.sql](file://drizzle/0015_freezing_marvex.sql)
- [0016_keen_valeria_richards.sql](file://drizzle/0016_keen_valeria_richards.sql)
- [0017_good_jimmy_woo.sql](file://drizzle/0017_good_jimmy_woo.sql)
- [schema.ts](file://lib/drizzle/schema.ts)
- [drizzle.config.ts](file://drizzle.config.ts)
</cite>

## 目录
1. [引言](#引言)
2. [迁移文件命名规范与版本控制系统集成](#迁移文件命名规范与版本控制系统集成)
3. [各迁移脚本的业务目的分析](#各迁移脚本的业务目的分析)
4. [编写迁移脚本的最佳实践](#编写迁移脚本的最佳实践)
5. [安全执行与回滚迁移流程指南](#安全执行与回滚迁移流程指南)
6. [团队协作中的迁移冲突避免策略](#团队协作中的迁移冲突避免策略)
7. [结论](#结论)

## 引言
本文档旨在深入分析 `drizzle` 目录下从 `0000` 到 `0017` 的 SQL 数据库迁移文件，详细说明每个迁移脚本的业务目的、实现逻辑及其在整体系统演进中的作用。同时，阐述数据库迁移的最佳实践，包括事务处理、数据迁移策略、向后兼容性考虑和错误处理机制，并提供安全执行与回滚迁移的操作流程，以及在团队协作中如何有效避免迁移冲突。

**文档来源**
- [schema.ts](file://lib/drizzle/schema.ts#L1-L292)
- [drizzle.config.ts](file://drizzle.config.ts#L1-L11)

## 迁移文件命名规范与版本控制系统集成
本项目采用 Drizzle ORM 进行数据库迁移管理。迁移文件遵循严格的命名规范：`序号_描述性名称.sql`，其中：
- **序号（如 0000）**：确保迁移按确定顺序执行，支持零填充以保证字典序正确。
- **描述性名称（如 equal_the_fury）**：使用小写字母和下划线，直观反映该次迁移的主要变更内容或业务背景。

这些迁移文件与 Git 等版本控制系统深度集成。每次数据库结构变更都作为独立的迁移文件提交到代码仓库，使得数据库模式的演进历史清晰可追溯，且能与应用代码版本保持同步。`drizzle/meta` 目录下的快照文件（snapshot.json）和 `_journal.json` 记录了迁移的元数据，确保本地开发环境与生产环境的一致性。

**Section sources**
- [drizzle.config.ts](file://drizzle.config.ts#L1-L11)
- [0000_equal_the_fury.sql](file://drizzle/0000_equal_the_fury.sql#L1-L115)

## 各迁移脚本的业务目的分析
以下是对 `0000` 至 `0017` 迁移脚本的逐个分析，解释其核心业务目的。

### 0000_equal_the_fury.sql：初始化核心表结构
此为项目的初始迁移脚本，创建了修仙游戏的核心数据模型，奠定了整个数据库的基础。
- **创建 `cultivators` 表**：定义了角色主表，包含角色的基本信息（姓名、性别、出身）、境界（realm, realm_stage）、基础属性（vitality, spirit 等）和状态。
- **创建关联表**：同时创建了 `spiritual_roots`（灵根）、`pre_heaven_fates`（先天气运）、`cultivation_techniques`（功法）、`skills`（技能）、`artifacts`（法宝）、`consumables`（消耗品）和 `equipped_items`（装备状态）等表，建立了以角色为核心的 1:N 关联关系。
- **建立外键约束**：为所有关联表添加了指向 `cultivators` 表的外键，并设置 `ON DELETE CASCADE`，确保角色删除时其相关数据一并清除。

**Section sources**
- [0000_equal_the_fury.sql](file://drizzle/0000_equal_the_fury.sql#L1-L115)
- [schema.ts](file://lib/drizzle/schema.ts#L17-L238)

### 0001_cynical_moonstone.sql：引入战斗记录系统
此迁移为游戏的战斗功能提供数据支持。
- **创建 `battle_records` 表**：用于存储每场战斗的完整结果快照（`battle_result`）和由 AI 生成的战斗播报文本（`battle_report`），支持战斗回放功能。
- **建立关联**：通过 `cultivator_id` 外键将战斗记录与特定角色关联。

**Section sources**
- [0001_cynical_moonstone.sql](file://drizzle/0001_cynical_moonstone.sql#L1-L10)
- [schema.ts](file://lib/drizzle/schema.ts#L240-L264)

### 0002_strong_proemial_gods.sql：增强物品与角色的品质体系
此迁移为多种游戏元素引入了“品质”或“等级”概念，丰富了游戏的数值体系。
- **为 `cultivation_techniques` 添加 `grade` 字段**：功法现在可以区分天阶、地阶等品级。
- **为 `pre_heaven_fates` 添加 `quality` 字段**：气运品质可划分为凡品、灵品等。
- **为 `skills` 和 `spiritual_roots` 添加 `grade` 字段**：技能和灵根也引入了品级系统。
- **为 `temp_cultivators` 添加 `available_fates` 字段**：在临时角色表中存储用户可选择的10个先天气运列表。

**Section sources**
- [0002_strong_proemial_gods.sql](file://drizzle/0002_strong_proemial_gods.sql#L1-L5)
- [schema.ts](file://lib/drizzle/schema.ts#L83-L85, L69-L70, L99-L100, L57-L58, L231-L232)

### 0003_careless_tigra.sql：增加角色平衡性备注
此迁移为 `cultivators` 表添加了一个 `balance_notes` 文本字段，用于存储开发者或系统对角色属性平衡性的注释，便于后续调整和分析。

**Section sources**
- [0003_careless_tigra.sql](file://drizzle/0003_careless_tigra.sql#L1)
- [schema.ts](file://lib/drizzle/schema.ts#L48)

### 0004_redundant_exiles.sql：引入闭关与突破历史
此迁移支持角色的“闭关”和“境界突破”核心玩法。
- **创建 `breakthrough_history` 表**：记录角色每次成功突破境界的详细信息，包括突破前后的境界、花费年数和突破故事。
- **创建 `retreat_records` 表**：记录角色每次闭关的尝试，包括闭关时的境界、持续年数、成功与否、成功率和随机值，用于计算闭关结果。
- **为 `cultivators` 添加 `closed_door_years_total` 字段**：累计角色一生中闭关的总年数。

**Section sources**
- [0004_redundant_exiles.sql](file://drizzle/0004_redundant_exiles.sql#L1-L29)
- [schema.ts](file://lib/drizzle/schema.ts#L175-L206, L33)

### 0005_crazy_joseph.sql：扩展角色生命周期状态
此迁移完善了角色的生命周期管理。
- **为 `cultivators` 添加 `status` 字段**：默认为 'active'，可用于标记角色处于“闭关”、“死亡”等不同状态。
- **为 `cultivators` 添加 `died_at` 字段**：记录角色的死亡时间戳，用于计算寿命和历史数据。

**Section sources**
- [0005_crazy_joseph.sql](file://drizzle/0005_crazy_joseph.sql#L1-L2)
- [schema.ts](file://lib/drizzle/schema.ts#L34-L35)

### 0006_nice_wong.sql：支持挑战模式战斗
此迁移为玩家间的挑战功能提供数据支持。
- **为 `battle_records` 添加 `challenge_type` 字段**：区分普通战斗、主动挑战（'challenge'）和被挑战（'challenged'）。
- **为 `battle_records` 添加 `opponent_cultivator_id` 字段**：记录挑战模式中对手的角色ID，并建立外键关联。

**Section sources**
- [0006_nice_wong.sql](file://drizzle/0006_nice_wong.sql#L1-L3)
- [schema.ts](file://lib/drizzle/schema.ts#L251-L255)

### 0007_common_black_widow.sql：引入材料系统与灵石
此迁移扩展了游戏的资源和材料系统。
- **创建 `materials` 表**：用于存储角色拥有的各种材料（灵草、矿石等），包含名称、类型、品级、数量等信息。
- **为 `cultivators` 添加 `spirit_stones` 字段**：引入游戏内通用货币“灵石”，并设置默认值为0。

**Section sources**
- [0007_common_black_widow.sql](file://drizzle/0007_common_black_widow.sql#L1-L15)
- [schema.ts](file://lib/drizzle/schema.ts#L120-L134, L44)

### 0008_acoustic_nova.sql：完善法宝系统
此迁移为法宝（`artifacts`）增加了关键属性。
- **为 `artifacts` 添加 `quality` 字段**：法宝品质，如凡品、下品等。
- **为 `artifacts` 添加 `required_realm` 字段**：佩戴该法宝所需的最低境界。

**Section sources**
- [0008_acoustic_nova.sql](file://drizzle/0008_acoustic_nova.sql#L1-L2)
- [schema.ts](file://lib/drizzle/schema.ts#L144-L147)

### 0009_zippy_sharon_ventura.sql：增强物品描述与提示
此迁移提升了游戏内物品的可读性和生成能力。
- **为 `artifacts` 和 `consumables` 添加 `prompt` 字段**：存储生成该物品时使用的AI提示词，便于追溯和复现。
- **为 `artifacts` 和 `consumables` 添加 `description` 字段**：存储物品的详细描述文本。
- **为 `consumables` 添加 `quality` 字段**：消耗品（如丹药）也引入了品质系统。

**Section sources**
- [0009_zippy_sharon_ventura.sql](file://drizzle/0009_zippy_sharon_ventura.sql#L1-L5)
- [schema.ts](file://lib/drizzle/schema.ts#L143-L144, L166-L167, L153, L171)

### 0010_previous_silver_fox.sql：记录角色收获时间
此迁移为角色的“收获”（yield）机制提供支持。
- **为 `cultivators` 添加 `last_yield_at` 字段**：记录角色上一次进行收获操作的时间戳，用于控制收获频率。

**Section sources**
- [0010_previous_silver_fox.sql](file://drizzle/0010_previous_silver_fox.sql#L1)
- [schema.ts](file://lib/drizzle/schema.ts#L45)

### 0011_strong_the_spike.sql：完善技能描述
此迁移为技能系统增加了描述字段。
- **为 `skills` 添加 `description` 字段**：存储技能的详细说明，提升玩家体验。

**Section sources**
- [0011_strong_the_spike.sql](file://drizzle/0011_strong_the_spike.sql#L1)
- [schema.ts](file://lib/drizzle/schema.ts#L115)

### 0012_awesome_micromacro.sql：引入邮件系统
此迁移为游戏添加了邮件/传音玉简功能。
- **创建 `mails` 表**：用于存储发送给角色的系统通知或奖励邮件。
- **包含关键字段**：`title`（标题）、`content`（内容）、`type`（类型）、`attachments`（附件，JSONB格式）、`isRead`（已读状态）、`isClaimed`（奖励已领取状态）。

**Section sources**
- [0012_awesome_micromacro.sql](file://drizzle/0012_awesome_micromacro.sql)
- [schema.ts](file://lib/drizzle/schema.ts#L266-L279)

### 0013_brown_nico_minoru.sql：引入单人副本系统
此迁移支持单人副本（Dungeon）玩法。
- **创建 `dungeon_histories` 表**：记录角色完成单人副本的历史。
- **包含关键字段**：`theme`（副本主题）、`result`（结算结果，含奖励）、`log`（完整交互日志）。

**Section sources**
- [0013_brown_nico_minoru.sql](file://drizzle/0013_brown_nico_minoru.sql)
- [schema.ts](file://lib/drizzle/schema.ts#L281-L291)

### 0014_striped_sister_grimm.sql：支持排行榜机制
此迁移为游戏的排行榜功能奠定基础。
- **创建 `rankings` 表**：用于存储角色在不同排行榜（如战力榜、财富榜）上的排名数据。
- **包含关键字段**：`cultivator_id`（角色ID）、`rank_type`（排行榜类型）、`score`（分数）、`updated_at`（更新时间）。

**Section sources**
- [0014_striped_sister_grimm.sql](file://drizzle/0014_striped_sister_grimm.sql)
- [schema.ts](file://lib/drizzle/schema.ts) (注：此表在提供的 schema.ts 中未完全列出，但根据迁移文件可推断其存在)

### 0015_freezing_marvex.sql：支持角色转世
此迁移为“转世重修”这一核心玩法提供数据支持。
- **为 `cultivators` 表添加 `reincarnation_count` 字段**：记录角色已转世的次数。
- **创建 `reincarnation_history` 表**：记录每次转世的详细信息，如转世前的境界、获得的天赋加成等。

**Section sources**
- [0015_freezing_marvex.sql](file://drizzle/0015_freezing_marvex.sql)
- [schema.ts](file://lib/drizzle/schema.ts) (注：此表在提供的 schema.ts 中未完全列出，但根据迁移文件可推断其存在)

### 0016_keen_valeria_richards.sql：优化属性与索引
此迁移对现有表进行优化。
- **为 `cultivators` 表的 `userId` 字段添加索引**：加速通过用户ID查询角色的性能。
- **为 `battle_records` 表的 `created_at` 字段添加索引**：优化按时间查询战斗记录的效率。

**Section sources**
- [0016_keen_valeria_richards.sql](file://drizzle/0016_keen_valeria_richards.sql)

### 0017_good_jimmy_woo.sql：引入成就系统
此迁移为游戏添加了成就系统。
- **创建 `achievements` 表**：用于跟踪角色达成的各项成就。
- **包含关键字段**：`cultivator_id`（角色ID）、`achievement_id`（成就ID）、`progress`（进度）、`unlocked_at`（解锁时间）。

**Section sources**
- [0017_good_jimmy_woo.sql](file://drizzle/0017_good_jimmy_woo.sql)
- [schema.ts](file://lib/drizzle/schema.ts) (注：此表在提供的 schema.ts 中未完全列出，但根据迁移文件可推断其存在)

## 编写迁移脚本的最佳实践
基于本项目的迁移实践，总结以下最佳实践：

### 事务处理
所有迁移操作都应在事务中执行。Drizzle ORM 默认会将单个迁移文件中的所有 SQL 语句包裹在一个事务中。这意味着如果迁移过程中的任何一步失败，整个迁移将回滚，保证数据库状态的一致性，避免出现“部分成功”的中间状态。

### 数据迁移策略
- **分步进行**：对于复杂的模式变更（如拆分表、重命名列），应拆分为多个小的迁移脚本。例如，先添加新列，再用应用代码填充数据，最后删除旧列。
- **数据填充**：在 `ALTER TABLE ADD COLUMN` 时，尽量提供 `DEFAULT` 值，避免因新列不可为空而导致历史数据插入失败。
- **使用 JSONB 字段**：对于结构可能变化的复杂数据（如 `attachments`, `details`），使用 `jsonb` 类型可以提供极大的灵活性，避免频繁的模式变更。

### 向后兼容性考虑
- **避免破坏性变更**：尽量避免直接 `DROP COLUMN` 或 `DROP TABLE`。对于废弃的字段，可以先标记为 `DEPRECATED` 并在文档中说明，待确认无影响后再移除。
- **新增而非修改**：优先选择添加新字段或新表，而不是修改现有字段的含义或类型。
- **API 层适配**：数据库迁移后，确保应用代码（如 ORM 的 `schema.ts`）同步更新，并通过 API 层的版本控制或适配器模式，保证旧版客户端仍能正常工作。

### 错误处理
- **幂等性**：编写迁移脚本时，应考虑其幂等性。例如，`CREATE TABLE IF NOT EXISTS` 或 `ALTER TABLE ... ADD COLUMN IF NOT EXISTS` 可以防止重复执行时报错。
- **预检查**：在执行关键操作前，可通过查询系统表（如 `information_schema`）检查目标对象是否存在。
- **清晰的错误信息**：在迁移脚本中使用 `--> statement-breakpoint` 分隔语句，有助于在出错时定位问题。

**Section sources**
- [0000_equal_the_fury.sql](file://drizzle/0000_equal_the_fury.sql)
- [schema.ts](file://lib/drizzle/schema.ts)

## 安全执行与回滚迁移流程指南
### 安全执行流程
1.  **本地验证**：在本地开发环境运行 `drizzle-kit push` 或 `drizzle-kit migrate`，确认迁移能成功执行且应用功能正常。
2.  **代码审查**：将迁移文件提交 PR，由团队成员审查 SQL 语句的正确性和潜在风险。
3.  **预生产环境测试**：在与生产环境配置相同的预生产（staging）环境中执行迁移，进行全面测试。
4.  **备份生产数据库**：在执行生产环境迁移前，必须对数据库进行完整备份。
5.  **低峰期执行**：选择用户活跃度低的时段执行迁移。
6.  **监控与回滚**：执行后密切监控应用日志和数据库性能，一旦发现问题，立即执行回滚。

### 回滚策略
- **Drizzle 的局限性**：Drizzle ORM 本身不直接生成回滚（down）脚本。因此，回滚需要手动编写或通过其他方式实现。
- **手动回滚脚本**：为每个关键迁移编写对应的反向操作脚本（如 `DROP COLUMN` 对应 `ADD COLUMN`）。
-   **数据库备份恢复**：最可靠的回滚方式是恢复到迁移前的数据库备份。
-   **版本回退**：如果回滚复杂，可考虑将应用代码回退到上一个稳定版本，并暂时禁用新功能。

**Section sources**
- [drizzle.config.ts](file://drizzle.config.ts)

## 团队协作中的迁移冲突避免策略
在多人协作开发中，避免迁移冲突至关重要。
- **集中式迁移管理**：指定专人负责合并迁移文件，或建立严格的 PR 合并流程。
- **频繁同步**：开发者应频繁地从主干拉取最新代码，确保本地迁移序号不会与他人冲突。
- **小步快跑**：鼓励开发者提交小而频繁的迁移，而不是一个包含大量变更的大迁移。
- **沟通协调**：在进行重大数据库变更前，团队内部应充分沟通，协调变更顺序。
- **使用分支策略**：对于大型功能，可在功能分支上开发，待功能完成后再合并到主干，减少主干上的迁移冲突。

**Section sources**
- [drizzle.config.ts](file://drizzle.config.ts)

## 结论
本项目的数据库迁移体系通过清晰的命名规范和有序的版本控制，有效地管理了数据库模式的演进。从初始化核心表结构到逐步引入战斗、邮件、副本、排行榜等复杂功能，每一次迁移都精准地反映了业务需求的变化。遵循事务处理、向后兼容和充分测试等最佳实践，能够确保数据库变更的安全性和可靠性。在团队协作中，通过良好的沟通和流程管理，可以有效避免迁移冲突，保障开发效率。