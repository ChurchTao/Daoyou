# 战斗与副本表

<cite>
**本文档引用的文件**   
- [schema.ts](file://lib/drizzle/schema.ts#L240-L291)
- [battleEngine.ts](file://engine/battleEngine.ts#L35-L829)
- [service_v2.ts](file://lib/dungeon/service_v2.ts#L299-L512)
- [types.ts](file://lib/dungeon/types.ts#L103-L116)
- [route.ts](file://app/api/battle/route.ts#L73-L120)
</cite>

## 目录
1. [战斗记录表 (battleRecords)](#战斗记录表-battlerecords)
2. [副本历史表 (dungeonHistories)](#副本历史表-dungeonhistories)
3. [应用场景](#应用场景)
4. [查询优化建议](#查询优化建议)

## 战斗记录表 (battleRecords)

`battleRecords` 表是存储所有战斗结果的核心数据表，其设计旨在完整保存战斗引擎的输出结果，并支持后续的战报生成、回放和数据分析。

### battleResult 字段结构

`battleResult` 字段是 `JSONB` 类型，直接存储 `BattleEngineResult` 接口的完整序列化数据。该结构由 `battleEngine.ts` 中的 `simulateBattle` 函数生成，包含以下关键信息：

- **winner** 和 **loser**：记录战斗双方角色的完整快照，包括所有属性、技能和装备。
- **log**：字符串数组，按回合顺序记录了战斗过程中的所有事件描述，如技能释放、状态变化和伤害计算。
- **turns**：记录战斗总回合数。
- **playerHp** 和 **opponentHp**：分别记录战斗结束时玩家和对手的剩余生命值。
- **timeline**：一个 `TurnSnapshot` 数组，记录了每个回合开始时双方角色的精确状态，包括生命值、灵力值和所有状态效果。这是实现战斗回放功能的关键。

该字段的设计确保了战斗结果的完整性和可重现性，任何一次战斗都可以被精确地复现和分析。

### battleReport 字段与 AIGC 生成

`battleReport` 字段是 `text` 类型，用于存储由 AI 生成的完整战斗播报文本。其生成流程如下：

1.  **战斗执行**：调用 `simulateBattle` 函数执行战斗，得到 `battleResult`。
2.  **提示词构建**：根据 `battleResult` 和角色信息，使用 `getBattleReportPrompt` 函数构建一个详细的 AI 提示词（Prompt）。
3.  **流式生成**：通过 `stream_text` 函数向 AI 模型发送提示词，并以流式方式接收生成的文本块。
4.  **结果存储**：将流式接收的所有文本块拼接成完整的战报，并与 `battleResult` 一起存入 `battleRecords` 表。

此设计将战斗的“数据”与“叙事”分离，`battleResult` 保证了数据的精确性，而 `battleReport` 则提供了生动、可读性强的战斗故事。

### challengeType 字段设计

`challengeType` 字段是 `varchar` 类型，用于区分不同类型的挑战。根据代码分析，其可能的值包括：
- **'challenge'**：主动发起的挑战。
- **'challenged'**：被其他玩家挑战。
- **'normal'**：普通的非竞技性战斗。

该字段的设计考量在于支持游戏内的多种战斗模式，特别是玩家间的 PVP 挑战系统。通过区分挑战类型，可以在成就系统、排行榜和用户界面中提供更精确的上下文。

**Section sources**
- [schema.ts](file://lib/drizzle/schema.ts#L240-L264)
- [battleEngine.ts](file://engine/battleEngine.ts#L35-L829)
- [route.ts](file://app/api/battle/route.ts#L73-L120)

## 副本历史表 (dungeonHistories)

`dungeonHistories` 表用于记录玩家完成的单人副本历练，存储了副本的最终结算数据和完整交互日志。

### result 字段存储结算数据

`result` 字段是 `JSONB` 类型，存储了副本的最终结算结果。该数据由 `DungeonService` 类的 `settleDungeon` 方法生成，其结构符合 `DungeonSettlementSchema`，核心内容包括：

- **ending_narrative**：一段由 AI 生成的结局叙述文本，描述了玩家在副本中的最终遭遇和收获。
- **settlement**：一个包含具体结算信息的对象：
  - **reward_tier**：奖励等级（S, A, B, C, D），代表了副本的总体评价和奖励丰厚程度。
  - **potential_items**：一个字符串数组，列出了玩家可能获得的物品类型（如法宝、材料等）。
  - **performance_tags**：一组评价标签（如“九死一生”、“险象环生”），用于概括玩家的历练表现。

该字段的设计实现了“AI评价 + 后端发放”的模式，AI 负责生成叙事和评价，而后端则根据评价等级从安全的奖励池中发放实际物品，确保了游戏经济的平衡。

### log 字段记录交互日志

`log` 字段是 `text` 类型，存储了副本过程中所有交互的完整日志。其内容是通过将 `DungeonState` 中的 `history` 数组格式化为字符串生成的，每条记录包含：
- **回合数 (Round)**：当前是第几轮互动。
- **场景描述 (scene)**：AI 生成的场景文本。
- **玩家选择 (Choice)**：玩家在该回合做出的选择。

这个字段为玩家提供了完整的历练回顾，是实现副本回放功能的基础。

**Section sources**
- [schema.ts](file://lib/drizzle/schema.ts#L281-L291)
- [service_v2.ts](file://lib/dungeon/service_v2.ts#L299-L512)
- [types.ts](file://lib/dungeon/types.ts#L103-L116)

## 应用场景

`battleRecords` 和 `dungeonHistories` 两张表在游戏系统中扮演着至关重要的角色。

### 战报回放
通过 `battleRecords` 表中的 `timeline` 字段，可以精确地复现每一场战斗。前端组件（如 `BattleTimelineViewer`）可以利用这些数据，逐帧展示战斗过程，实现类似“录像”的功能。`dungeonHistories` 表的 `log` 字段则允许玩家回顾整个副本的决策过程。

### 成就系统
这两张表是成就系统的重要数据来源。例如，可以查询 `battleRecords` 表，统计玩家获得“十连胜”或“以弱胜强”的次数；也可以查询 `dungeonHistories` 表，判断玩家是否完成了特定主题的副本或获得了 S 级评价。

### 数据分析
运营团队可以对这两张表进行聚合分析，以了解玩家行为。例如，分析 `battleRecords` 中 `challengeType` 的分布，可以评估 PVP 系统的活跃度；分析 `dungeonHistories` 中 `reward_tier` 的分布，可以评估副本的难度曲线是否合理。

## 查询优化建议

为了高效地查询这两张表，特别是当数据量增长时，应考虑以下优化建议：

1.  **创建时间范围索引**：为 `battleRecords` 和 `dungeonHistories` 表的 `created_at` 字段创建 B-Tree 索引，以加速基于时间的查询（如“查询过去一周的战斗记录”）。
    ```sql
    CREATE INDEX idx_battle_records_created_at ON wanjiedaoyou_battle_records(created_at);
    CREATE INDEX idx_dungeon_histories_created_at ON wanjiedaoyou_dungeon_histories(created_at);
    ```

2.  **创建外键索引**：为 `battleRecords` 表的 `cultivatorId` 和 `dungeonHistories` 表的 `cultivatorId` 创建索引，以加速按角色查询其历史记录。
    ```sql
    CREATE INDEX idx_battle_records_cultivator_id ON wanjiedaoyou_battle_records(cultivator_id);
    CREATE INDEX idx_dungeon_histories_cultivator_id ON wanjiedaoyou_dungeon_histories(cultivator_id);
    ```

3.  **利用 JSONB 索引**：如果需要频繁查询 `battleResult` 或 `result` 字段中的特定属性（如 `winner.id` 或 `settlement.reward_tier`），可以创建 GIN 索引以提高查询效率。
    ```sql
    CREATE INDEX idx_battle_records_result_gin ON wanjiedaoyou_battle_records USING GIN (battle_result);
    CREATE INDEX idx_dungeon_histories_result_gin ON wanjiedaoyou_dungeon_histories USING GIN (result);
    ```