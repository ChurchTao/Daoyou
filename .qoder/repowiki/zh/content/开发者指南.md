# 开发者指南

<cite>
**本文档中引用的文件**  
- [ENV_SETUP.md](file://ENV_SETUP.md)
- [package.json](file://package.json)
- [README.md](file://README.md)
- [jest.config.js](file://jest.config.js)
- [.prettierrc](file://.prettierrc)
- [eslint.config.mjs](file://eslint.config.mjs)
- [drizzle.config.ts](file://drizzle.config.ts)
- [lib/drizzle/db.ts](file://lib/drizzle/db.ts)
- [lib/drizzle/schema.ts](file://lib/drizzle/schema.ts)
- [lib/supabase/client.ts](file://lib/supabase/client.ts)
- [lib/supabase/server.ts](file://lib/supabase/server.ts)
- [lib/redis/index.ts](file://lib/redis/index.ts)
- [tsconfig.json](file://tsconfig.json)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [环境搭建](#环境搭建)
4. [依赖安装](#依赖安装)
5. [环境变量配置](#环境变量配置)
6. [数据库连接设置](#数据库连接设置)
7. [本地运行、构建与测试](#本地运行构建与测试)
8. [代码风格与提交规范](#代码风格与提交规范)
9. [调试技巧](#调试技巧)
10. [测试策略](#测试策略)
11. [贡献流程](#贡献流程)

## 简介

《万界道友》是一款以 AIGC 驱动、高自由度文字体验和修仙世界观为核心的开源游戏项目。本指南旨在帮助新开发者快速搭建本地开发环境，理解项目配置，并顺利开始贡献代码。

项目基于 Next.js 构建，使用 Supabase 作为后端服务，Drizzle 进行数据库操作，Redis 实现缓存与排行榜功能，并通过 OpenAI 或兼容 API 实现 AI 驱动生成内容。

**Section sources**
- [README.md](file://README.md#L1-L282)

## 项目结构

项目采用模块化设计，主要目录如下：

- `app/`：Next.js 页面路由与 UI 组件
- `components/`：可复用的前端组件，包含 Ink 风格 UI 框架
- `engine/`：核心游戏逻辑，如战斗引擎、角色生成策略
- `lib/`：共享库，包括数据库连接、认证、Redis 客户端等
- `drizzle/`：数据库迁移文件与 schema 快照
- `utils/`：工具函数，如命运生成、角色构建、提示词管理
- `types/`：TypeScript 类型定义
- 根目录包含配置文件（如 `package.json`, `tsconfig.json`, `ENV_SETUP.md`）

**Section sources**
- [README.md](file://README.md#L156-L187)

## 环境搭建

### 前置条件

- Node.js v18 或更高版本
- 包管理器：推荐使用 `npm`（也可使用 `pnpm` 或 `yarn`）
- Git（用于克隆仓库）

**Section sources**
- [README.md](file://README.md#L192-L195)

## 依赖安装

在项目根目录执行以下命令安装依赖：

```bash
npm install
```

该命令将根据 `package.json` 安装所有生产与开发依赖，包括：
- Next.js 框架
- Drizzle ORM 与数据库驱动
- Supabase 认证支持
- Redis 客户端（@upstash/redis）
- 测试框架 Jest
- 代码格式化工具 Prettier 和 ESLint 插件

**Section sources**
- [package.json](file://package.json#L1-L54)

## 环境变量配置

### 创建 `.env.local` 文件

在项目根目录创建 `.env.local` 文件，用于本地开发环境配置。

#### 必需配置

```bash
# OpenAI API Key（必需）
OPENAI_API_KEY=sk-your-api-key-here
```

#### 可选配置

```bash
# 自定义 API 地址（用于兼容其他 OpenAI 兼容的 API）
OPENAI_BASE_URL=https://api.openai.com/v1

# 使用的模型名称（默认：gpt-4o-mini）
OPENAI_MODEL=gpt-4o-mini
```

### 获取 API Key

1. **OpenAI 官方**：访问 https://platform.openai.com/api-keys
2. **OpenRouter**：访问 https://openrouter.ai/keys
3. **DeepSeek**：访问 https://platform.deepseek.com/api_keys

> 注意：`.env.local` 已被 `.gitignore` 忽略，不会提交至版本控制。修改后需重启开发服务器生效。

**Section sources**
- [ENV_SETUP.md](file://ENV_SETUP.md#L1-L39)

## 数据库连接设置

项目使用 **Supabase + Drizzle ORM** 进行数据持久化。

### 环境变量

确保 `.env.local` 中包含以下 Supabase 配置：

```bash
NEXT_PUBLIC_SUPABASE_URL=your-supabase-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
DATABASE_URL=your-postgres-connection-string
```

### 数据库初始化

运行 Drizzle 迁移以创建表结构：

```bash
npx drizzle-kit migrate
```

该命令会根据 `drizzle.config.ts` 和 `lib/drizzle/schema.ts` 中定义的 schema 创建或更新数据库表。

### Schema 说明

`lib/drizzle/schema.ts` 定义了核心数据模型，包括：
- `cultivators`：修士主表
- `spiritualRoots`：灵根（一对多）
- `preHeavenFates`：先天气运
- `skills`：技能与神通
- `artifacts`：法宝装备
- `battleRecords`：战斗记录
- `mails`：邮件系统

**Section sources**
- [drizzle.config.ts](file://drizzle.config.ts#L1-L11)
- [lib/drizzle/db.ts](file://lib/drizzle/db.ts#L1-L13)
- [lib/drizzle/schema.ts](file://lib/drizzle/schema.ts#L1-L292)
- [lib/supabase/client.ts](file://lib/supabase/client.ts#L1-L9)
- [lib/supabase/server.ts](file://lib/supabase/server.ts#L1-L28)

## 本地运行构建与测试

### 本地开发服务器

启动开发模式：

```bash
npm run dev
```

应用将在 `http://localhost:3000` 启动，支持热重载。

### 构建生产版本

生成生产优化的静态资源：

```bash
npm run build
```

### 运行测试

执行单元与集成测试：

```bash
npm run test
```

测试框架使用 Jest，配置文件为 `jest.config.js`，已集成 Next.js 支持。

**Section sources**
- [package.json](file://package.json#L5-L11)
- [jest.config.js](file://jest.config.js#L1-L19)

## 代码风格与提交规范

### 代码格式化

使用 Prettier 统一代码风格：

```bash
npm run format
```

`.prettierrc` 配置如下：
- 使用单引号
- 结尾分号
- 缩进 2 个空格
- 行宽 80
- 尾随逗号（all）
- 启用 Tailwind CSS、导入排序和 package.json 自动排序插件

### 代码检查

使用 ESLint 进行静态分析：

```bash
npm run lint
```

ESLint 配置基于 `eslint-config-next`，确保符合 Next.js 最佳实践。

### 提交规范

建议提交信息遵循简洁明了的原则，格式为：
```
<type>: <description>
```
常见类型：`feat`（功能）、`fix`（修复）、`docs`（文档）、`style`（样式）、`refactor`（重构）、`test`（测试）、`chore`（工具）

**Section sources**
- [.prettierrc](file://.prettierrc#L1-L14)
- [eslint.config.mjs](file://eslint.config.mjs#L1-L19)
- [package.json](file://package.json#L8-L9)

## 调试技巧

### API 路由调试

API 路由位于 `app/api/` 目录下，如：
- `app/api/battle/route.ts`
- `app/api/cultivators/[id]/route.ts`

可在路由处理函数中添加 `console.log()` 或使用 VS Code 调试器断点调试。

### Redis 连接测试

Redis 客户端封装在 `lib/redis/index.ts`，通过 `Redis.fromEnv()` 自动读取环境变量。

测试连接示例：

```ts
import { redis } from '@/lib/redis';
const ping = await redis.ping(); // 应返回 'PONG'
```

确保环境变量 `UPSTASH_REDIS_REST_URL` 和 `UPSTASH_REDIS_REST_TOKEN` 已配置。

**Section sources**
- [lib/redis/index.ts](file://lib/redis/index.ts#L1-L6)
- [app/api/battle/route.ts](file://app/api/battle/route.ts)
- [app/api/cultivators/[id]/route.ts](file://app/api/cultivators/[id]/route.ts)

## 测试策略

### 测试框架

使用 Jest 作为测试运行器，配置支持：
- 异步测试
- 全局超时设置（10秒）
- Next.js 环境模拟

### 测试文件命名

测试文件以 `.test.ts` 或 `.test.tsx` 结尾，与被测文件同目录或 `__tests__` 目录下。

示例：
- `engine/creation/strategies/RefiningStrategy.test.ts`
- `lib/services/MailService.test.ts`

### 测试覆盖率

建议对核心逻辑（如战斗引擎、角色生成、数值计算）编写单元测试，对 API 路由进行集成测试。

**Section sources**
- [jest.config.js](file://jest.config.js#L1-L19)
- [engine/creation/strategies/RefiningStrategy.test.ts](file://engine/creation/strategies/RefiningStrategy.test.ts)
- [lib/services/MailService.test.ts](file://lib/services/MailService.test.ts)

## 贡献流程

欢迎任何形式的贡献！

### 推荐流程

1. Fork 仓库
2. 创建特性分支：`feature/xxx` 或修复分支：`fix/xxx`
3. 提交代码并编写清晰的提交信息
4. 发起 Pull Request，说明改动动机与设计思路

### 可贡献方向

- 新玩法设计（境界、状态、法宝）
- AIGC Prompt 优化（`utils/prompts.ts`）
- UI/UX 改进（遵循 `ui.md` 规范）
- 文档完善与翻译
- Bug 修复与性能优化

对于大型改动，建议先通过 Issue 讨论设计草案。

**Section sources**
- [README.md](file://README.md#L229-L247)