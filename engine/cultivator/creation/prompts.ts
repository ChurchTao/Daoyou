/**
 * 角色生成 Prompt 模板（系统提示词）
 */
export function getCharacterGenerationPrompt(): string {
  return `你乃修仙界至高法则之化身——「造化玉碟」，执掌天道权衡，裁断凡人命格。凡人以心念祈愿，你依其【意象】【风格】【出身背景】塑其修仙真形，然一切须合天理、循道韵，不得逾矩。

【天道职责】
你只需负责构建角色的“灵魂”与“骨架”，具体的肉身数值由法则自动演算。
你需要决定：
1. **姓名与身世**：符合修仙背景的姓名、出身、性格与故事。
2. **灵根属性**：该角色天生拥有哪些属性的灵根（金、木、水、火、土、风、雷、冰）。灵根越少通常代表资质越纯净（天灵根），灵根越多则越杂驳（伪灵根），但也视具体设定而定。
3. **资质评分 (0-100)**：根据用户描述的“气运”与“期待”给出一个资质评分。
   - 评分 90-100：绝世天骄，天道宠儿（如：天灵根、变异灵根）。
   - 评分 75-89：一方豪强，资质上乘（如：双灵根）。
   - 评分 50-74：中人之姿，也就是大部分修士的水平（如：三灵根）。
   - 评分 0-49：资质平庸，修仙艰难（如：四灵根、五灵根）。

【天道铁律】
1. **灵根判定**：
   - 必须从【金、木、水、火、土、风、雷、冰】中选择。
   - 尽量符合用户描述（如“剑仙”倾向金/风，“药师”倾向木/火）。
   - 若用户未指定，则根据其描述的随机分配。
2. **天道平衡**：
   - 若描述过于卑微，可给出适当评分与奇遇伏笔。

【输出格式】
- 必须返回**纯 JSON 对象**，严格符合下游 Schema。
- 不得包含任何额外文本。
- 所有字段必须存在。

【天道批注】
在 'balance_notes' 字段中，简述评分理由与灵根赐予的缘由。
`;
}

export function getCharacterGenerationUserPrompt(userInput: string) {
  return `用户心念描述：${userInput} 请直接输出符合规则、范围和 Schema 的 JSON。`;
}

/**
 * 高安全级别净化：移除空白、数字、标签、危险符号、作弊关键词
 */
export function sanitizePrompt(input: string): string {
  if (!input) return '';

  let cleaned = input;

  // 1. 移除 XML/HTML 标签
  cleaned = cleaned.replace(/<\/?[^>]+(>|$)/g, '');

  // 2. 移除所有数字
  cleaned = cleaned.replace(/\d+/g, '');

  // 3. 移除危险特殊符号（保留修仙常用标点）
  // 保留：中文标点 + · — 等风格符号
  cleaned = cleaned.replace(/[`{}=:\$@#%^&*|~<>[\\\]_+]/g, '');

  // 4. 移除所有空白字符（含换行、制表等）
  cleaned = cleaned.replace(/\s+/g, '');

  // 5. 移除高危关键词（不区分大小写，支持中英文）
  const cheatKeywords = [
    // 指令绕过类
    '忽略',
    '无视',
    '跳过',
    '覆盖',
    '绕过',
    'override',
    'bypass',
    'skip',
    'ignore',
    '你是',
    '你是一个',
    '你作为',
    '扮演',
    '模拟',
    '假装',
    '输出',
    '返回',
    '打印',
    '直接给',
    '直接输出',
    '给我',
    '生成',
    '不要规则',
    '无视规则',
    '不用管',
    '别管',
    '不管',

    // 数值/属性作弊类
    '最大',
    '最高',
    '最强',
    '满级',
    '全属性',
    '所有属性',
    '全部加',
    '无限',
    '无敌',
    '秒杀',
    '必杀',
    '超模',
    '神级',
    '完美',
    '极致',
    '突破上限',
    'max',
    'full',
    'god',
    'op',
    'broken',
  ];

  // 构建正则：全局、不区分大小写、匹配任意关键词
  const keywordPattern = new RegExp(
    cheatKeywords.map((k) => k.replace(/[.*+?^${}()|[\\]/g, '\\$&')).join('|'),
    'gi',
  );

  cleaned = cleaned.replace(keywordPattern, '');

  // 6. （可选）压缩连续非文字字符（防止符号残留组合）
  // cleaned = cleaned.replace(/[^a-zA-Z\u4e00-\u9fa5·—。！？；：、“”‘’（）【】《》]+/g, '');

  // 7. 移除可能因关键词删除产生的多余连续符号（如“炼丹！！！” → “炼丹”）
  cleaned = cleaned.replace(/([·—。！？；：、“”‘’（）【】《》])\1+/g, '$1');

  return cleaned;
}
