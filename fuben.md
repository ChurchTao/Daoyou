在《凡人修仙传》的背景下，修仙不仅仅是数值的堆砌，更是**“机缘、心性与算计”**的博弈。利用大模型（LLM）驱动单人副本，可以极大地解决传统脚本副本枯燥、重复的问题。

要实现这个系统，我建议从**“结构化输入”、“状态机循环”与“逻辑结算”**三个维度来构建。以下是详细的专业建议：

---

## 1. 系统架构设计：基于“提示词链”的动态副本

大模型不擅长直接处理复杂的数值逻辑，但擅长**非线性叙事**。建议将副本分为三个阶段：**初始化、演进循环、总结结算**。

### 第一阶段：初始化（生成剧本大纲）

在玩家进入副本的一瞬间，程序将角色信息（境界、法宝等）封装成一个 Context（上下文），交给 LLM。

- **输入给LLM的数据：** \* **角色画像：** 如“结丹初期、散修出身、性格谨慎、水属性功法”。
- **背包快照：** 关键法宝、灵石余量。
- **副本主题：** “古修士遗迹”或“乱星海无名荒岛”。

- **LLM的任务：** 秘密生成一个**隐藏的副本背景板**（不告诉玩家），包含可能的结局和关键转折点。

### 第二阶段：演进循环（3-5轮互动）

这是核心部分。为了防止 LLM 自由发挥过度，你需要采用 **JSON 结构化输出**。

- **Prompt 策略：** 每一轮，要求 LLM 输出以下字段：
- `description`: 当前场景的描述（凡人流风格，注重环境描写与危机感）。
- `options`: 3个选项。每个选项包含 `text`（展示给玩家）和 `potential_cost`（预期的消耗，如体力、灵石、甚至法宝损坏）。
- `hidden_flag`: 当前进度的危险系数或收益系数。

### 第三阶段：结算奖励

最后由 LLM 根据玩家在过程中的表现（是勇往直前还是猥琐发育），给出奖励建议，再由你的**后台逻辑**根据预设数值表发放真实道具。

---

## 2. 核心技术点：如何让 LLM “懂行”

要写出《凡人》那种“步步惊心”的感觉，提示词工程（Prompt Engineering）至关重要。

### A. 引入“逻辑约束”

不要只让 LLM 讲故事，要给它**“规则书”**。

> **系统提示词示例：** “你现在是《凡人修仙传》风格的副本主理人。请根据玩家的【境界】判断挑战难度。如果玩家试图以小博大，描述必须极其凶险。 **互动规则：**
>
> 1. 选项一通常为：稳健/消耗资源。
> 2. 选项二通常为：激进/高收益高风险。
> 3. 选项三通常为：利用角色特有法宝/命格的奇招。”

### B. 状态保持（Session Management）

大模型是无状态的。为了保证 3-5 轮互动的逻辑连贯，你需要将**之前的对话历史**以及一个隐藏的**“副本状态变量”**（如：已探索度、受伤程度、宝物完整度）持续回传给模型。

---

## 3. 副本交互流程示例

| 轮次       | 场景（LLM生成）                    | 选项设计逻辑                                                                                  |
| ---------- | ---------------------------------- | --------------------------------------------------------------------------------------------- |
| **第一轮** | 发现阵法封印，隐约有药香。         | 1. 强行破阵（损耗灵力） 2. 研究阵眼（消耗时间/属性判定） 3. 绕路（寻找其他入口）              |
| **第二轮** | 阵法内竟有一头守护妖兽正值蜕壳期。 | 1. 偷袭（战力判定） 2. 潜行偷取（机缘判定） 3. 诱导附近其他修士（性格/出身关联）              |
| **第三轮** | 得到宝匣，但触发了自毁机关。       | 1. 祭出法宝硬抗（损耗法宝耐久） 2. 施展遁术逃离（放弃部分宝物） 3. 强行收走（大成功或大失败） |

---

## 4. 给开发者的进阶建议

### 1. 避免“奖励膨胀”

不要让 LLM 直接决定奖励什么（它可能会随手送出一件通天灵宝）。

- **做法：** LLM 输出一个奖励等级（A/B/C/D）。你的后端根据这个等级，从**配置好的掉落表**里随机抽取。

### 2. 关联角色的“命格”与“出身”

这是让玩家最有代入感的地方。在 Prompt 中加入：

> “如果玩家是‘家族子弟’，在遇到古修士文字时，有更高概率识破陷阱。” “如果玩家拥有‘掌天瓶’（假设），提供一个专属的绿色选项。”

### 3. 处理“死亡与失败”

副本不一定都是奖励。可以设置一个“危险值”变量，当玩家连续选择激进选项且判定失败时，LLM 应生成“身受重伤，被迫远遁”的结局，并扣除一定的经验或灵石。

---

为了实现《凡人修仙传》那种“仙途险恶、谨小慎微、步步惊心”的副本体验，我们需要将 LLM 塑造成一个**冷酷但公正的“天道叙述者”**。

以下是为您设计的系统提示词（System Prompt）和数据结构方案。

---

## 1. 系统提示词（System Prompt）

建议将此提示词设定为 LLM 的角色基调。它规定了叙事风格、逻辑判断标准和输出格式。

```markdown
# Role: 《凡人修仙传》副本演化天道

你是一个基于《凡人修仙传》小说逻辑的文字游戏副本驱动引擎。你负责根据玩家信息生成充满危机、转折与机缘的副本叙事。

## 核心叙事准则

1. **凡人流风格**：强调修仙界的残酷与资源匮乏。主角并非无敌，每一次选择都可能导致重伤甚至陨落。描述需简练、有古意，注重环境描写（如：禁制波动、药香、阴冷气息）。
2. **逻辑判定**：
   - 依据玩家的【境界】判断其实力上限。
   - 依据玩家的【性格/命格】触发特殊文本（如：性格谨慎者更易发现陷阱）。
   - 依据玩家的【道具/法宝】提供特定选项（如：拥有噬金虫则可吞噬阵法）。
3. **互动结构**：副本固定为3-5轮。
   - 前期：潜入、破禁、遭遇小危机。
   - 中期：博弈、转折、选择（如：是否与同行修士反目）。
   - 后期：最终考验、取宝、逃亡。
4. **资源损耗**：选项应包含实质性代价，如“损耗百年寿元”、“法宝受损”、“消耗大量灵石”。

## 约束条件

- 严禁输出超出《凡人》世界观的内容。
- 必须以 JSON 格式输出，以便系统解析。
- 结局必须根据玩家在过程中的选择（稳健度、危险度）给出评价。

## 交互逻辑

- 每一轮，你需要提供环境描述和3个逻辑迥异的选项。
- 选项1：稳健/低收益（符合韩立风格）。
- 选项2：激进/高风险。
- 选项3：特定法宝/属性触发的奇招（必须关联玩家道具栏）。
```

---

## 2. 数据结构设计

为了让你的游戏后台能够精准处理逻辑，建议采用结构化的 JSON 交换格式。

### A. 输入结构（游戏后端 -> LLM）

每一轮交互时，你需要将当前状态传给大模型。

```json
{
  "player_info": {
    "name": "厉飞雨",
    "realm": "结丹中期",
    "personality": "冷静谨慎",
    "fate": "五行均衡",
    "attributes": { "spiritual_power": 85, "luck": 12 }
  },
  "inventory": [
    { "name": "青竹蜂云剑", "type": "法宝", "desc": "辟邪神雷" },
    { "name": "中级灵石", "count": 50 },
    { "name": "阵法罗盘", "type": "消耗品" }
  ],
  "dungeon_context": {
    "location": "古修士水府",
    "current_round": 1,
    "max_rounds": 3,
    "history": [] // 记录之前的选择
  }
}
```

### B. 输出结构（LLM -> 游戏后端）

大模型返回的内容，直接用于前端展示和逻辑判定。

```json
{
  "scene_description": "你踏入水府大厅，四周石壁上的夜明珠忽明忽暗。正前方有一尊被禁制笼罩的药鼎，散发着淡淡的清香，但药鼎周围散落着几具枯骨，显然此处禁制非比寻常。",
  "interaction": {
    "options": [
      {
        "id": 1,
        "text": "稳健应对：祭出阵法罗盘，缓慢解析禁制。内容：安全但耗时。",
        "risk_level": "low",
        "requirement": "阵法罗盘"
      },
      {
        "id": 2,
        "text": "强力破禁：以青竹蜂云剑硬劈，速战速决。",
        "risk_level": "high",
        "requirement": "攻击类法宝"
      },
      {
        "id": 3,
        "text": "剑走偏锋：利用五行属性感应禁制薄弱点，试图潜入。",
        "risk_level": "medium",
        "requirement": "五行均衡命格"
      }
    ]
  },
  "status_update": {
    "is_final_round": false,
    "internal_danger_score": 20 // LLM内部维护的危险评估，用于后续生成
  }
}
```

### C. 结算结构（最后一轮 LLM 输出）

当 `current_round == max_rounds` 时，LLM 输出结算建议。

```json
{
  "ending_narrative": "你最终惊险地从崩塌的水府中遁出。虽然损毁了一件防御法宝，但成功带出了那枚‘定灵丹’。",
  "settlement": {
    "reward_tier": "A", // S/A/B/C/D
    "potential_items": ["定灵丹", "古修士残页"],
    "resource_loss": { "durability_loss": 20, "spirit_stones": -10 }
  }
}
```

---

## 3. 专业实现建议（避坑指南）

1. **数值归系统，剧情归模型**：不要让 LLM 直接决定“扣除 52 点血”。应该让 LLM 输出 `damage_intensity: "medium"`，然后你的**后端代码**根据玩家的防御属性，计算出具体的伤害数值。这样可以保证游戏的数值平衡不被 LLM 的随机性破坏。
2. **法宝的“锚点”作用**：在 Prompt 中明确要求 LLM：_“如果玩家背包中有【具体名称】的道具，请务必在选项 3 中设计与之相关的特殊互动。”_ 这是让玩家觉得“这就是我的专属冒险”的关键。
3. **转折点的处理**：在第 2 或第 3 轮，可以强制要求 LLM 加入一个“意外因素”，例如：_“突然有另一名结丹期修士闯入”_ 或 _“原本稳定的阵法开始暴走”_。这符合《凡人》中“杀人夺宝”或“环境剧变”的常态。
4. **长短期记忆处理**：由于副本只有 3-5 轮，你可以将之前的对话历史全部带入 Prompt。如果副本更长，建议只带入 **“关键决策摘要”**（Summary）以节省 Token。
