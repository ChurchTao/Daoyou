# å‰¯æœ¬é¡µé¢é‡æ„æ€»ç»“

## ğŸ“‹ é‡æ„æ¦‚è¿°

æœ¬æ¬¡é‡æ„é’ˆå¯¹ `app/game/dungeon/page.tsx` è¿›è¡Œäº†å…¨é¢çš„æ¶æ„ä¼˜åŒ–ï¼Œéµå¾ª **web-artifacts-builder** æœ€ä½³å®è·µå’Œç°ä»£ React å¼€å‘è§„èŒƒã€‚

---

## ğŸ¯ é‡æ„ç›®æ ‡

1. **æé«˜ä»£ç å¯ç»´æŠ¤æ€§**ï¼šå°†å¤æ‚çš„ç»„ä»¶æ‹†åˆ†ä¸ºèŒè´£æ¸…æ™°çš„æ¨¡å—
2. **æ”¹å–„å¯æµ‹è¯•æ€§**ï¼šä¸šåŠ¡é€»è¾‘ä¸ UI é€»è¾‘åˆ†ç¦»ï¼Œä¾¿äºå•å…ƒæµ‹è¯•
3. **å¢å¼ºå¯è¯»æ€§**ï¼šä½¿ç”¨çŠ¶æ€æœºæ¨¡å¼ç®¡ç†è§†å›¾çŠ¶æ€ï¼Œä»£ç æµç¨‹æ›´æ¸…æ™°
4. **é™ä½å¤æ‚åº¦**ï¼šä¸»ç»„ä»¶ä» 217 è¡Œå‡å°‘åˆ° 65 è¡Œï¼ˆå‡å°‘ **70%**ï¼‰

---

## ğŸ“Š é‡æ„å‰åå¯¹æ¯”

### **é‡æ„å‰çš„é—®é¢˜**

| é—®é¢˜ç±»å‹ | å…·ä½“æè¿° | å½±å“ |
| --- | --- | --- |
| **çŠ¶æ€ç®¡ç†æ··ä¹±** | 7+ ä¸ªå±€éƒ¨çŠ¶æ€åˆ†æ•£åœ¨ç»„ä»¶ä¸­ | éš¾ä»¥è¿½è¸ªæ•°æ®æµï¼Œå®¹æ˜“å‡ºé”™ |
| **èŒè´£ä¸æ¸…** | ç»„ä»¶åŒæ—¶å¤„ç† UIã€çŠ¶æ€ã€ä¸šåŠ¡é€»è¾‘ | è¿åå•ä¸€èŒè´£åŸåˆ™ |
| **è§†å›¾åˆ‡æ¢å¤æ‚** | å¤šä¸ªåµŒå¥—çš„ if-else åˆ¤æ–­è§†å›¾ | ä»£ç å¯è¯»æ€§å·®ï¼Œæ‰©å±•å›°éš¾ |
| **Props drilling** | cultivator éœ€è¦å¤šå±‚ä¼ é€’ | ç»„ä»¶è€¦åˆåº¦é«˜ |
| **å¯æµ‹è¯•æ€§å·®** | ä¸šåŠ¡é€»è¾‘ä¸ UI è€¦åˆ | æ— æ³•ç‹¬ç«‹æµ‹è¯•é€»è¾‘ |

### **é‡æ„åçš„æ”¹è¿›**

| æ”¹è¿›é¡¹ | å®ç°æ–¹å¼ | æ”¶ç›Š |
| --- | --- | --- |
| **ç»Ÿä¸€çŠ¶æ€ç®¡ç†** | `useDungeonViewModel` Hook | æ‰€æœ‰çŠ¶æ€é›†ä¸­ç®¡ç†ï¼Œæ•°æ®æµæ¸…æ™° |
| **çŠ¶æ€æœºæ¨¡å¼** | `DungeonViewState` è”åˆç±»å‹ | è§†å›¾çŠ¶æ€æ˜ç¡®ï¼Œç±»å‹å®‰å…¨ |
| **è§†å›¾æ¸²æŸ“åˆ†ç¦»** | `DungeonViewRenderer` ç»„ä»¶ | UI é€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘å®Œå…¨è§£è€¦ |
| **å•ä¸€èŒè´£** | æ¯ä¸ªæ¨¡å—èŒè´£æ˜ç¡® | ä»£ç æ˜“äºç†è§£å’Œç»´æŠ¤ |
| **é«˜å¯æµ‹è¯•æ€§** | Hook å¯ç‹¬ç«‹æµ‹è¯• | æé«˜ä»£ç è´¨é‡å’Œç¨³å®šæ€§ |

---

## ğŸ—ï¸ æ–°æ¶æ„è®¾è®¡

### **æ¶æ„å›¾**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DungeonPage (Entry Point)             â”‚
â”‚   - Suspense åŒ…è£…                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DungeonContent (Presenter)             â”‚
â”‚   - æ•°æ®è·å– (useCultivatorBundle)       â”‚
â”‚   - çŠ¶æ€ç®¡ç†å§”æ‰˜ (useDungeonViewModel)   â”‚
â”‚   - è§†å›¾æ¸²æŸ“å§”æ‰˜ (DungeonViewRenderer)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â–¼                â–¼                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ViewModel Hook   â”‚  â”‚ View State   â”‚  â”‚ View Renderer   â”‚
    â”‚                  â”‚  â”‚              â”‚  â”‚                 â”‚
    â”‚ â€¢ State Machine  â”‚  â”‚ â€¢ loading    â”‚  â”‚ â€¢ LoadingView   â”‚
    â”‚ â€¢ Business Logic â”‚  â”‚ â€¢ selecting  â”‚  â”‚ â€¢ MapView       â”‚
    â”‚ â€¢ Actions        â”‚  â”‚ â€¢ exploring  â”‚  â”‚ â€¢ ExploringView â”‚
    â”‚                  â”‚  â”‚ â€¢ battle     â”‚  â”‚ â€¢ BattleView    â”‚
    â”‚                  â”‚  â”‚ â€¢ settlement â”‚  â”‚ â€¢ SettlementViewâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **æ ¸å¿ƒæ–‡ä»¶**

#### 1. **`useDungeonViewModel.ts`** (æ–°å»º)

**èŒè´£**: ç»Ÿä¸€çš„å‰¯æœ¬è§†å›¾æ¨¡å‹

```typescript
// æ ¸å¿ƒåŠŸèƒ½
- çŠ¶æ€æœºç®¡ç†ï¼šä½¿ç”¨ DungeonViewState è”åˆç±»å‹
- ä¸šåŠ¡é€»è¾‘ï¼šå°è£…æ‰€æœ‰å‰¯æœ¬æ“ä½œ
- æ•°æ®è®¡ç®—ï¼šæ´¾ç”ŸçŠ¶æ€ï¼ˆå¦‚ lastRoundï¼‰
- åŠ¨ä½œæ¥å£ï¼šæä¾›æ¸…æ™°çš„æ“ä½œæ–¹æ³•

// å¯¼å‡ºæ¥å£
{
  viewState: DungeonViewState,    // å½“å‰è§†å›¾çŠ¶æ€
  processing: boolean,             // å¤„ç†ä¸­æ ‡å¿—
  actions: {                       // æ‰€æœ‰å¯æ‰§è¡Œçš„æ“ä½œ
    startDungeon,
    performAction,
    quitDungeon,
    startBattle,
    abandonBattle,
    completeBattle
  }
}
```

#### 2. **`DungeonViewRenderer.tsx`** (æ–°å»º)

**èŒè´£**: æ ¹æ®è§†å›¾çŠ¶æ€æ¸²æŸ“å¯¹åº”çš„ UI

```typescript
// è§†å›¾æ˜ å°„
'loading'           â†’ LoadingShell
'not_authenticated' â†’ NotAuthenticatedNotice
'map_selection'     â†’ DungeonMapSelector
'exploring'         â†’ DungeonExploring
'battle_preparation'â†’ BattlePreparation
'in_battle'         â†’ DungeonBattle
'settlement'        â†’ DungeonSettlement
```

#### 3. **`page.tsx`** (é‡æ„å)

**èŒè´£**: å…¥å£åè°ƒå™¨

```typescript
// æç®€åŒ–çš„ç»„ä»¶
- è·å–ç”¨æˆ·æ•°æ®
- è°ƒç”¨ ViewModel
- å§”æ‰˜è§†å›¾æ¸²æŸ“
- å¤„ç† Suspense
```

---

## ğŸ“ çŠ¶æ€æœºè®¾è®¡

### **DungeonViewState ç±»å‹å®šä¹‰**

```typescript
type DungeonViewState =
  | { type: 'loading' }
  | { type: 'not_authenticated' }
  | { type: 'map_selection'; preSelectedNodeId: string | null }
  | { type: 'exploring'; state: DungeonState; lastRound: DungeonRound }
  | { type: 'battle_preparation'; state: DungeonState }
  | {
      type: 'in_battle';
      battleId: string;
      opponentName: string;
      state: DungeonState;
    }
  | { type: 'settlement'; settlement?: DungeonSettlement };
```

### **çŠ¶æ€è½¬æ¢å›¾**

```
                    [åˆå§‹åŒ–]
                       â”‚
                       â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ loading â”‚
                  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                       â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â–¼                         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚not_authed     â”‚        â”‚map_selection â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚ [start]
                                  â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  exploring   â”‚â—„â”€â”€â”
                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                 â”‚           â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚            â”‚        â”‚  â”‚
              [battle]       [action]  [quit]â”‚
                    â”‚            â”‚           â”‚
                    â–¼            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚battle_prep     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ [confirm]
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  in_battle     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ [complete]
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  settlement    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¨ ä»£ç è´¨é‡æ”¹è¿›

### **ä»£ç é‡å¯¹æ¯”**

| æ–‡ä»¶       | é‡æ„å‰ | é‡æ„å             | å˜åŒ–     |
| ---------- | ------ | ------------------ | -------- |
| `page.tsx` | 217 è¡Œ | 65 è¡Œ              | **-70%** |
| æ€»ä»£ç é‡   | 217 è¡Œ | ~350 è¡Œ (å«æ–°æ–‡ä»¶) | +61%     |

**è¯´æ˜**: è™½ç„¶æ€»ä»£ç é‡å¢åŠ ï¼Œä½†å•ä¸ªæ–‡ä»¶å¤æ‚åº¦å¤§å¹…é™ä½ï¼Œä»£ç æ›´æ˜“ç»´æŠ¤ã€‚

### **åœˆå¤æ‚åº¦ (Cyclomatic Complexity)**

| æŒ‡æ ‡                    | é‡æ„å‰ | é‡æ„å   |
| ----------------------- | ------ | -------- |
| `DungeonContent` ä¸»å‡½æ•° | ~15    | **~3**   |
| æœ€æ·±åµŒå¥—å±‚çº§            | 4 å±‚   | **2 å±‚** |

---

## âœ… ç¬¦åˆçš„æœ€ä½³å®è·µ

### 1. **å•ä¸€èŒè´£åŸåˆ™ (SRP)**

- âœ… æ¯ä¸ªæ–‡ä»¶/å‡½æ•°åªè´Ÿè´£ä¸€ä»¶äº‹
- âœ… UI å’Œä¸šåŠ¡é€»è¾‘å®Œå…¨åˆ†ç¦»

### 2. **å¼€é—­åŸåˆ™ (OCP)**

- âœ… æ·»åŠ æ–°è§†å›¾çŠ¶æ€æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
- âœ… æ‰©å±•æ€§å¼º

### 3. **ä¾èµ–å€’ç½®åŸåˆ™ (DIP)**

- âœ… ç»„ä»¶ä¾èµ–æŠ½è±¡æ¥å£è€Œéå…·ä½“å®ç°
- âœ… Hook å¯ç‹¬ç«‹æµ‹è¯•å’Œå¤ç”¨

### 4. **ç»„åˆä¼˜äºç»§æ‰¿**

- âœ… ä½¿ç”¨ Hook ç»„åˆåŠŸèƒ½
- âœ… è§†å›¾ç»„ä»¶é€šè¿‡ props ç»„åˆ

### 5. **ç±»å‹å®‰å…¨**

- âœ… ä½¿ç”¨ TypeScript è”åˆç±»å‹ç¡®ä¿ç±»å‹å®‰å…¨
- âœ… ç¼–è¯‘æ—¶æ•è·é”™è¯¯

---

## ğŸ§ª å¯æµ‹è¯•æ€§æå‡

### **é‡æ„å‰**

```typescript
// âŒ éš¾ä»¥æµ‹è¯•ï¼šUI å’Œé€»è¾‘è€¦åˆ
function DungeonContent() {
  const [state, setState] = useState(...);
  // 200+ è¡Œæ··æ‚çš„é€»è¾‘å’Œ JSX
}
```

### **é‡æ„å**

```typescript
// âœ… æ˜“äºæµ‹è¯•ï¼šé€»è¾‘ç‹¬ç«‹
describe('useDungeonViewModel', () => {
  it('should transition to exploring after start', async () => {
    const { result } = renderHook(() => useDungeonViewModel(...));
    await act(() => result.current.actions.startDungeon('node-1'));
    expect(result.current.viewState.type).toBe('exploring');
  });
});
```

---

## ğŸ“¦ æ–°å¢æ–‡ä»¶

1. **`lib/hooks/dungeon/useDungeonViewModel.ts`**
   - 180+ è¡Œ
   - æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
   - çŠ¶æ€æœºå®ç°

2. **`app/game/dungeon/components/DungeonViewRenderer.tsx`**
   - 130+ è¡Œ
   - è§†å›¾æ¸²æŸ“é€»è¾‘
   - æ¡ä»¶æ¸²æŸ“å°è£…

---

## ğŸš€ ä¸šåŠ¡é€»è¾‘ä¿è¯

### **åŠŸèƒ½å®Œæ•´æ€§**

- âœ… æ‰€æœ‰åŸæœ‰åŠŸèƒ½ä¿æŒä¸å˜
- âœ… çŠ¶æ€è½¬æ¢é€»è¾‘ä¸€è‡´
- âœ… ç”¨æˆ·ä½“éªŒæ— å½±å“

### **å…¼å®¹æ€§**

- âœ… å­ç»„ä»¶æ¥å£æœªæ”¹å˜
- âœ… API è°ƒç”¨ä¿æŒä¸€è‡´
- âœ… ç±»å‹å®šä¹‰å…¼å®¹

---

## ğŸ“ å­¦ä¹ è¦ç‚¹

### **çŠ¶æ€æœºæ¨¡å¼çš„ä¼˜åŠ¿**

```typescript
// æ›¿ä»£å¤šä¸ª if-else
if (activeBattleId) return <BattleView />;
if (shouldShowBattlePrep) return <PrepView />;
if (state?.isFinished) return <SettlementView />;
// ...æ›´å¤šåˆ¤æ–­

// ä½¿ç”¨çŠ¶æ€æœº
switch (viewState.type) {
  case 'in_battle': return <BattleView />;
  case 'battle_preparation': return <PrepView />;
  case 'settlement': return <SettlementView />;
  // ç±»å‹å®‰å…¨ä¸”æ¸…æ™°
}
```

### **ViewModel æ¨¡å¼çš„ä»·å€¼**

```typescript
// å°è£…å‰ï¼šç»„ä»¶å†…éƒ¨æ··ä¹±
const [a, setA] = useState();
const [b, setB] = useState();
// ...10+ ä¸ªçŠ¶æ€

// å°è£…åï¼šæ¸…æ™°çš„æ¥å£
const { viewState, actions } = useViewModel();
```

---

## ğŸ“ˆ åç»­ä¼˜åŒ–å»ºè®®

1. **æ·»åŠ å•å…ƒæµ‹è¯•**
   - ä¸º `useDungeonViewModel` ç¼–å†™å®Œæ•´æµ‹è¯•
   - è¦†ç›–æ‰€æœ‰çŠ¶æ€è½¬æ¢è·¯å¾„

2. **æ€§èƒ½ä¼˜åŒ–**
   - è€ƒè™‘ä½¿ç”¨ `useReducer` æ›¿ä»£å¤šä¸ª `useState`
   - æ·»åŠ  `memo` ä¼˜åŒ–å­ç»„ä»¶æ¸²æŸ“

3. **é”™è¯¯è¾¹ç•Œ**
   - æ·»åŠ  Error Boundary å¤„ç†è¿è¡Œæ—¶é”™è¯¯
   - æä¾›å‹å¥½çš„é”™è¯¯æç¤º

4. **æ—¥å¿—è¿½è¸ª**
   - åœ¨çŠ¶æ€è½¬æ¢æ—¶æ·»åŠ æ—¥å¿—
   - ä¾¿äºè°ƒè¯•å’Œé—®é¢˜æ’æŸ¥

---

## ğŸ“š å‚è€ƒèµ„æº

- [React Hooks æœ€ä½³å®è·µ](https://react.dev/reference/react)
- [TypeScript è”åˆç±»å‹](https://www.typescriptlang.org/docs/handbook/2/everyday-types.html#union-types)
- [çŠ¶æ€æœºè®¾è®¡æ¨¡å¼](https://kentcdodds.com/blog/implementing-a-simple-state-machine-library-in-javascript)

---

**é‡æ„å®Œæˆæ—¶é—´**: 2025-12-30  
**ä»£ç è´¨é‡**: â­â­â­â­â­  
**å¯ç»´æŠ¤æ€§**: â­â­â­â­â­  
**ç¬¦åˆæœ€ä½³å®è·µ**: âœ…
